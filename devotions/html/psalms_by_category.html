<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Psalms by Category</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div style="text-align: center; margin-bottom: 40px;">
        <h1>Psalms by Category</h1>
        <p>Select a category to view a Psalm and prayer for reflection.</p>
    </div>

    ${category_cards_html}

    <div style="text-align: center;">
        <a href="/" class="button">Back to Home</a>
    </div>

    <script>
        function toggleCard(header) {
            const card = header.parentElement;
            card.classList.toggle('collapsed');
        }

        async function loadAnotherPsalm(button, cardIndex) {
            const psalmList = JSON.parse(button.dataset.psalms);
            const currentRefEl = document.getElementById('psalm-ref-' + cardIndex);
            const currentPsalmNum = currentRefEl.innerText.replace('Psalm ', '');

            let potentialPsalms = psalmList.filter(p => p !== currentPsalmNum);
            if (potentialPsalms.length === 0 && psalmList.length > 0) {
                potentialPsalms = psalmList;
            } else if (potentialPsalms.length === 0 && psalmList.length === 0) {
                return; // No psalms to load
            }
            
            const newPsalmNum = potentialPsalms[Math.floor(Math.random() * potentialPsalms.length)];
            const newRef = 'Psalm ' + newPsalmNum;

            const textEl = document.getElementById('psalm-text-' + cardIndex);

            button.disabled = true;
            button.innerText = 'Loading...';
            currentRefEl.innerText = newRef;
            textEl.innerHTML = '<em>Loading...</em>';

            try {
                const response = await fetch('/get_passage_text?ref=' + encodeURIComponent(newRef));
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                textEl.innerHTML = data.text;
            } catch (error) {
                console.error('Error fetching new psalm:', error);
                textEl.innerHTML = '<em>Error loading Psalm. Please try again.</em>';
                currentRefEl.innerText = 'Psalm ' + currentPsalmNum; // Revert ref on error
            } finally {
                button.disabled = false;
                button.innerText = 'Load Another Psalm';
            }
        }
    </script>
</body>
</html>