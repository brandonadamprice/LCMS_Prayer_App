{% extends "base.html" %}
{% block title %}Sign In{% endblock %}
{% block content %}
<div class="page-header">
  <h1>Sign In / Sign Up</h1>
  <p>Create an account or sign in to save your preferences, prayer requests, and more.</p>
</div>

<div class="card">
  <h2>Sign In</h2>
  <div style="text-align: center; margin-top: 20px;">
    <a href="/login/google" class="button" style="background-color: #4285F4; border: 1px solid #4285F4; padding: 12px 24px; font-size: 1.1em;">
      Sign in with Google
    </a>
    <button onclick="fbLogin()" class="button" style="background-color: #1877F2; border: 1px solid #1877F2; padding: 12px 24px; font-size: 1.1em; margin-left: 10px;">
      Sign in with Facebook
    </button>
  </div>
  <p style="text-align: center; margin-top: 20px; font-size: 0.9em; color: #7f8c8d;">
    More sign-in options coming soon.
  </p>
</div>

<script>
  window.fbAsyncInit = function() {
    FB.init({
      appId      : '{{ facebook_app_id }}', // Your App ID
      cookie     : true,
      xfbml      : true,
      version    : 'v18.0'
    });
    FB.AppEvents.logPageView();   
  };

  (function(d, s, id){
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement(s); js.id = id;
     js.src = "https://connect.facebook.net/en_US/sdk.js";
     fjs.parentNode.insertBefore(js, fjs);
   }(document, 'script', 'facebook-jssdk'));

  function fbLogin() {
    FB.login(function(response) {
        if (response.authResponse) {
            console.log('Welcome!  Fetching your information.... ');
            // Send the access token to the server
            fetch('/login/facebook/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ accessToken: response.authResponse.accessToken }),
            })
            .then(response => {
                if (response.redirected) {
                    window.location.href = response.url;
                } else if (response.ok) {
                    window.location.href = "/";
                } else {
                    console.error('Login failed on server');
                    alert('Login failed. Please try again.');
                }
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('An error occurred during login.');
            });
        } else {
            console.log('User cancelled login or did not fully authorize.');
        }
    }, {scope: 'email,public_profile'});
  }
</script>
{% endblock %}
