{% extends "base.html" %}
{% block title %}Sign In{% endblock %}
{% block content %}
<div class="page-header">
  <h1>Sign In / Sign Up</h1>
  <p>Create an account or sign in to save your preferences, prayer requests, and more.</p>
</div>

<div class="card">
  <h2>Sign In</h2>
  <div style="text-align: center; margin-top: 20px;">
    <a href="/login/google" class="button" style="background-color: #4285F4; border: 1px solid #4285F4; padding: 12px 24px; font-size: 1.1em;">
      Sign in with Google
    </a>
    <button onclick="fbLogin()" class="button" style="background-color: #1877F2; border: 1px solid #1877F2; padding: 12px 24px; font-size: 1.1em; margin-left: 10px;">
      Sign in with Facebook
    </button>
  </div>
  <p style="text-align: center; margin-top: 10px; font-size: 0.9em; color: #e74c3c;">
    <strong>Note:</strong> Sign in with Facebook is currently experiencing issues on mobile devices. We are attempting to get it working as soon as possible.
  </p>
  <p style="text-align: center; margin-top: 20px; font-size: 0.9em; color: #7f8c8d;">
    More sign-in options coming soon.
  </p>
  
  <!-- Debug Log Container -->
  <div id="debug-log" style="margin-top: 20px; padding: 10px; background: #f0f0f0; border: 1px solid #ccc; font-family: monospace; font-size: 0.8em; max-height: 200px; overflow-y: auto; display: none;">
    <strong>Debug Log:</strong><br>
  </div>
  <div style="text-align: center; margin-top: 10px;">
      <button class="button" style="font-size: 0.8em; padding: 5px 10px; background-color: #95a5a6;" onclick="toggleDebug()">Toggle Debug Log</button>
      <button class="button" style="font-size: 0.8em; padding: 5px 10px; background-color: #e67e22;" onclick="showTroubleshoot()">Troubleshoot</button>
  </div>
  
  <div id="troubleshoot-info" style="display: none; margin-top: 15px; text-align: left; background: #fff3cd; padding: 10px; border: 1px solid #ffeeba; border-radius: 5px; font-size: 0.9em;">
      <strong>Facebook Login Setup:</strong><br>
      If you see "URL Blocked", you must add this exact URL to your Facebook App Settings:<br>
      <code id="redirect-uri-display" style="background: #eee; padding: 2px 5px; display: block; margin: 5px 0; word-break: break-all;"></code>
      <ol style="padding-left: 20px; margin-top: 5px;">
          <li>Go to <a href="https://developers.facebook.com/apps/" target="_blank">Facebook Developers</a></li>
          <li>Select your App</li>
          <li>Go to <strong>Facebook Login > Settings</strong> (sidebar)</li>
          <li>Find <strong>Valid OAuth Redirect URIs</strong></li>
          <li>Paste the URL above and click <strong>Save Changes</strong></li>
      </ol>
  </div>
</div>

<script>
  function log(msg) {
      console.log(msg);
      const debugDiv = document.getElementById('debug-log');
      if (debugDiv) {
          debugDiv.innerHTML += msg + '<br>';
          debugDiv.scrollTop = debugDiv.scrollHeight;
      }
  }

  function toggleDebug() {
      const debugDiv = document.getElementById('debug-log');
      if (debugDiv.style.display === 'none') {
          debugDiv.style.display = 'block';
      } else {
          debugDiv.style.display = 'none';
      }
  }

  function showTroubleshoot() {
      const tsDiv = document.getElementById('troubleshoot-info');
      const uriDisplay = document.getElementById('redirect-uri-display');
      
      // Calculate exact current URI including protocol and www/non-www
      const currentUri = window.location.origin + window.location.pathname;
      uriDisplay.textContent = currentUri;
      
      if (tsDiv.style.display === 'none') {
          tsDiv.style.display = 'block';
      } else {
          tsDiv.style.display = 'none';
      }
  }

  window.fbAsyncInit = function() {
    log("FB SDK Initializing...");
    try {
        FB.init({
          appId      : '{{ facebook_app_id }}', // Your App ID
          cookie     : true,
          xfbml      : true,
          version    : 'v18.0'
        });
        log("FB.init completed.");
        FB.AppEvents.logPageView();
    } catch (e) {
        log("Error in FB.init: " + e.message);
    }
  };

  (function(d, s, id){
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement(s); js.id = id;
     js.src = "https://connect.facebook.net/en_US/sdk.js";
     fjs.parentNode.insertBefore(js, fjs);
   }(document, 'script', 'facebook-jssdk'));

  function isMobile() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  }

  function fbLogin() {
    const appId = '{{ facebook_app_id }}';
    // Ensure we use the exact current location base, handling www vs non-www
    const redirectUri = window.location.origin + window.location.pathname; 
    
    // On mobile, bypass the popup entirely and use the redirect flow
    if (isMobile()) {
        log("Mobile device detected. Using Redirect Flow.");
        log("Redirect URI to Whitelist: " + redirectUri);
        
        const scope = 'email,public_profile';
        const authUrl = `https://www.facebook.com/v18.0/dialog/oauth?client_id=${appId}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=token&scope=${encodeURIComponent(scope)}`;
        window.location.href = authUrl;
        return;
    }

    log("Desktop detected. Calling FB.login (Popup Flow)...");
    if (location.protocol !== 'https:') {
        log("WARNING: Page is not HTTPS. Facebook Login requires HTTPS.");
    }
    
    FB.login(function(response) {
        log("FB.login callback received.");
        log("Response status: " + response.status);
        
        if (response.authResponse) {
            handleAuthResponse(response.authResponse.accessToken);
        } else {
            log("User cancelled login or did not fully authorize.");
            log("Full response: " + JSON.stringify(response));

            if (response.status === 'unknown') {
               log("Status is unknown. Popups blocked?");
               alert("Login popup was blocked or closed. Please try again or use a different browser.");
            }
        }
    }, {scope: 'email,public_profile'});
  }

  function handleAuthResponse(accessToken) {
      log("Auth success. Token length: " + accessToken.length);
      log("Sending token to server...");
      
      fetch('/login/facebook/token', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
          },
          body: JSON.stringify({ accessToken: accessToken }),
      })
      .then(response => {
          log("Server response received. Status: " + response.status);
          return response.json();
      })
      .then(data => {
          log("Server data: " + JSON.stringify(data));
          if (data.redirect) {
              log("Redirecting to: " + data.redirect);
              window.location.href = data.redirect;
          } else if (data.success) {
              log("Login success! Redirecting home.");
              window.location.href = "/";
          } else {
              log("Server reported failure: " + (data.error || "Unknown"));
              alert('Login failed: ' + (data.error || "Please try again."));
          }
      })
      .catch((error) => {
          log("Fetch error: " + error.message);
          console.error('Error:', error);
          alert('An error occurred during login.');
      });
  }

  // Check for access token in URL hash (returned from Facebook Manual Flow fallback)
  window.addEventListener('load', function() {
      const hash = window.location.hash;
      if (hash && hash.includes('access_token=')) {
          log("Found access_token in URL hash. Processing manual flow...");
          const params = new URLSearchParams(hash.substring(1)); // remove #
          const accessToken = params.get('access_token');
          
          if (accessToken) {
              log("Got access token from hash, verifying with server...");
              // Clear hash to clean up URL
              history.replaceState(null, null, ' ');

              fetch('/login/facebook/token', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({ accessToken: accessToken }),
              })
              .then(response => response.json())
              .then(data => {
                  if (data.redirect) {
                      window.location.href = data.redirect;
                  } else if (data.success) {
                      window.location.href = "/";
                  } else {
                      log('Login failed on server: ' + data.error);
                      alert('Login failed. Please try again.');
                  }
              })
              .catch((error) => {
                  log('Error: ' + error);
                  alert('An error occurred during login.');
              });
          }
      }
  });
</script>
{% endblock %}
