{% extends "base.html" %}
{% block title %}Sign In{% endblock %}
{% block content %}
<div class="page-header">
  <h1>Sign In / Sign Up</h1>
  <p>Create an account or sign in to save your preferences, prayer requests, and more.</p>
</div>

<div class="card">
  <h2>Sign In</h2>
  <div style="text-align: center; margin-top: 20px;">
    <a href="/login/google" class="button" style="background-color: #4285F4; border: 1px solid #4285F4; padding: 12px 24px; font-size: 1.1em;">
      Sign in with Google
    </a>
    <button onclick="fbLogin()" class="button" style="background-color: #1877F2; border: 1px solid #1877F2; padding: 12px 24px; font-size: 1.1em; margin-left: 10px;">
      Sign in with Facebook
    </button>
  </div>
  <p style="text-align: center; margin-top: 20px; font-size: 0.9em; color: #7f8c8d;">
    More sign-in options coming soon.
  </p>
</div>

<script>
  // Facebook Login - Manual Implicit Flow to avoid Popups on Mobile
  function fbLogin() {
      const appId = '{{ facebook_app_id }}';
      const redirectUri = window.location.origin + '/login'; 
      const scope = 'email,public_profile';
      const authUrl = `https://www.facebook.com/v18.0/dialog/oauth?client_id=${appId}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=token&scope=${encodeURIComponent(scope)}`;
      
      window.location.href = authUrl;
  }

  // Check for access token in URL hash (returned from Facebook)
  window.addEventListener('load', function() {
      const hash = window.location.hash;
      if (hash && hash.includes('access_token=')) {
          const params = new URLSearchParams(hash.substring(1)); // remove #
          const accessToken = params.get('access_token');
          
          if (accessToken) {
              console.log('Got access token, verifying with server...');
              // Clear hash to clean up URL
              history.replaceState(null, null, ' ');

              fetch('/login/facebook/token', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({ accessToken: accessToken }),
              })
              .then(response => response.json())
              .then(data => {
                  if (data.redirect) {
                      window.location.href = data.redirect;
                  } else if (data.success) {
                      window.location.href = "/";
                  } else {
                      console.error('Login failed on server:', data.error);
                      alert('Login failed. Please try again.');
                  }
              })
              .catch((error) => {
                  console.error('Error:', error);
                  alert('An error occurred during login.');
              });
          }
      }
  });
</script>
{% endblock %}
