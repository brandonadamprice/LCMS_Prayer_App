{% extends "base.html" %}
{% import "_macros.html" as macros %}
{% block title %}Midday Devotion{% endblock %}
{% block content %}
    <div class="page-header" style="--bg-image: url('{{ url_for('static', filename='banner_midday.jpg') }}');">
      <h1>Midday Devotion</h1>
      <p>
        {{ date_str }}<br />
        <span style="color: #7f8c8d">Lectionary Day: {{ key }}</span>
      </p>
      <p style="font-style: italic; margin-top: 10px;">"What else is it but tempting God when your mouth babbles and the mind wanders to other thoughts? Like the cleric who prayed, 'Deus in adjutorium meum intende.' [Make haste, O God, to deliver me; Ps. 70:1]. 'Farmhand, did you unhitch the horses?' Domine ad adjuvandum me festina. [Make haste to help me, O Lord.] 'Maid, go out and milk the cow.' Gloria patri et filio et spiritui sancto. [Glory be to the Father and to the Son and to the Holy Spirit.] 'Hurry up, boy, I wish the ague take you!'" — Martin Luther</p>
    </div>

    {% call macros.card('Opening') %}
        <p>
          <span class="rubric"
            >The sign of the cross may be made by all in remembrance of their Baptism.</span
          >
        </p>
        <p>
          In the name of the Father and of the † Son and of the Holy Spirit.<br />
          <strong> Amen.</strong>
        </p>
        <p>
          Listen to my prayer, O God, do not ignore my plea;<br />
          <strong>hear me and answer me.</strong>
        </p>
        <p>
          Evening, morning, and noon<br />
          <strong>I cry out in distress, and He hears my voice.</strong>
        </p>
        <p>
          Cast your cares on the Lord and He will sustain you;<br />
          <strong>He will never let the righteous fall.</strong>
          <span class="versicle-ref">Psalm 55:1-2a, 17, 22</span>
        </p>
        {{ macros.format_prayer(config['OTHER_PRAYERS']['gloria_patri']) }}
    {% endcall %}

    {% call macros.card('Psalmody') %}
        <span class="ref" id="ref-psalm">{{ psalm_ref }}</span>
        <p id="text-psalm">{{ psalm_text|safe }}</p>
        {% if psalm_options %}
        <button class="button picker-toggle-button" onclick="togglePicker(this, 'psalm')">Select Psalm</button>
        <div id="picker-psalm" class="item-picker">
            {% for p in psalm_options %}
            <button class="button picker-select-button" onclick="selectRef('{{ p }}', 'psalm')">{{ p }}</button>
            {% endfor %}
        </div>
        {% endif %}
        {{ macros.format_prayer(config['OTHER_PRAYERS']['gloria_patri']) }}
    {% endcall %}

    {% call macros.card('Reading') %}
        <div id="office-reading-container">
            <span class="ref" id="ref-reading">{{ reading_ref }}</span>
            <p id="text-reading">{{ reading_text|safe }}</p>
            <button class="button picker-toggle-button" id="office-picker-btn" onclick="togglePicker(this, 'reading')">Select Reading</button>
            <div id="picker-reading" class="item-picker">
                {% for r in reading_options %}
                <button class="button picker-select-button" onclick="selectRef('{{ r }}', 'reading')">{{ r }}</button>
                {% endfor %}
            </div>
        </div>

        <div id="lectionary-reading-container" style="display: none;">
            {% if daily_lectionary_readings %}
                <p class="subheader"><strong>Old Testament Reading</strong></p>
                <span class="ref">{{ daily_lectionary_readings[0] }}</span>
                <p>{{ lectionary_texts[0]|safe }}</p>
                {% if daily_lectionary_readings|length > 1 %}
                    <hr>
                    <p class="subheader"><strong>New Testament Reading</strong></p>
                    <span class="ref">{{ daily_lectionary_readings[1] }}</span>
                    <p>{{ lectionary_texts[1]|safe }}</p>
                {% endif %}
            {% else %}
                <p><em>No Daily Lectionary readings available for today.</em></p>
            {% endif %}
        </div>

        <div style="margin-top: 10px;">
            <button id="btn-toggle-lectionary" class="button" onclick="toggleLectionaryReadings()" style="background-color: #2980b9;">Switch to Daily Lectionary</button>
        </div>
    {% endcall %}

    {% call macros.card('Prayers') %}
        <p>
          O Lord, <strong>have mercy upon us.</strong><br />
          O Christ, <strong>have mercy upon us.</strong><br />
          O Lord, <strong>have mercy upon us.</strong>
        </p>
        <hr />
        {{ macros.format_prayer(config['OTHER_PRAYERS']['lords_prayer']) }}
        <hr />
        <p><em>(You may offer your own prayers at this time)</em></p>
        {{ macros.personal_prayers_toggle(all_personal_prayers) }}
        <hr />
        <p class="subheader"><strong>Concluding Prayer</strong></p>
        {{ macros.format_prayer(concluding_prayer) }}
    {% endcall %}

    {% call macros.card('Conclusion') %}
        <p>
          Let us bless the Lord.<br />
          <strong>Thanks be to God.</strong>
        </p>
    {% endcall %}
{% endblock %}

{% block extra_js %}
    let isLectionaryMode = false;

    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('reading_type') === 'lectionary') {
            toggleLectionaryReadings();
        }
    });

    function toggleLectionaryReadings() {
       const btn = document.getElementById('btn-toggle-lectionary');
       const officeContainer = document.getElementById('office-reading-container');
       const lectionaryContainer = document.getElementById('lectionary-reading-container');
       const picker = document.getElementById('picker-reading');
       const pickerBtn = document.getElementById('office-picker-btn');

       if (isLectionaryMode) {
           // Swap back to Office
           officeContainer.style.display = 'block';
           lectionaryContainer.style.display = 'none';
           btn.innerText = "Switch to Daily Lectionary";
           isLectionaryMode = false;
       } else {
           // Swap to Lectionary
           // Close picker if open to reset state
           if (picker.classList.contains('visible')) {
               togglePicker(pickerBtn, 'reading');
           }
           
           officeContainer.style.display = 'none';
           lectionaryContainer.style.display = 'block';
           btn.innerText = "Back to Office Reading";
           isLectionaryMode = true;
       }
    }
{% endblock %}
