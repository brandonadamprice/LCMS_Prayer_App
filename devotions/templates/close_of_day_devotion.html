{% extends "base.html" %}
{% import "_macros.html" as macros %}
{% block title %}Close of the Day Devotion{% endblock %}
{% block content %}
    <div class="page-header">
      <h1>Close of the Day</h1>
      <p>
        {{ date_str }}<br />
        <span style="color: #7f8c8d">Lectionary Day: {{ key }}</span>
      </p>
    </div>

    {% call macros.card('Opening') %}
        <p>
          <span class="rubric"
            >The sign of the cross may be made by all in remembrance of their Baptism.</span
          >
        </p>
        <p>
          In the name of the Father and of the â€  Son and of the Holy Spirit.<br />
          <strong> Amen.</strong>
        </p>
        <p>
          The Lord Almighty grant us a quiet night and peace at the last.<br />
          <strong>Amen.</strong>
        </p>
        <p>
          It is good to give thanks to the Lord,<br />
          <strong>To sing praise to Your name, O Most High;</strong><br />
          To herald Your love in the morning,<br />
          <strong>Your truth at the close of the day.</strong>
          <span class="versicle-ref">Psalm 92:1-2</span>
        </p>
    {% endcall %}

    {% call macros.card('Psalmody') %}
        <span class="ref" id="ref-psalm">{{ psalm_ref }}</span>
        <p id="text-psalm">{{ psalm_text|safe }}</p>
        {% if psalm_options %}
        <button class="button picker-toggle-button" onclick="togglePicker(this, 'psalm')">Select Psalm</button>
        <div id="picker-psalm" class="item-picker">
            {% for p in psalm_options %}
            <button class="button picker-select-button" onclick="selectRef('{{ p }}', 'psalm')">{{ p }}</button>
            {% endfor %}
        </div>
        {% endif %}
        {{ macros.format_prayer(config['OTHER_PRAYERS']['gloria_patri']) }}
    {% endcall %}

    {% call macros.card('Reading') %}
        <span class="ref" id="ref-reading">{{ reading_ref }}</span>
        <p id="text-reading">{{ reading_text|safe }}</p>
        
        <div style="margin-top: 10px;">
            <button id="btn-toggle-lectionary" class="button" onclick="toggleLectionaryReadings()" style="background-color: #2980b9;">Switch to Daily Lectionary</button>
            <button class="button picker-toggle-button" onclick="togglePicker(this, 'reading')">Select Reading</button>
        </div>

        <div id="picker-reading" class="item-picker">
            {% for r in reading_options %}
            <button class="button picker-select-button" onclick="selectRef('{{ r }}', 'reading')">{{ r }}</button>
            {% endfor %}
        </div>
    {% endcall %}

    {% call macros.card('Creed') %}
        {{ macros.format_prayer(config['OTHER_PRAYERS']['apostles_creed']) }}
    {% endcall %}

    {% call macros.card('Prayers') %}
        {{ macros.format_prayer(config['OTHER_PRAYERS']['nunc_dimittis']) }}
        <hr />
        {{ macros.format_prayer(config['OTHER_PRAYERS']['lords_prayer']) }}
        <hr />
        <p class="subheader">
          <strong>Topic:</strong> <span class="prayer-topic">{{ prayer_topic }}</span>
        </p>
        <p>Lord, hear our prayer. <strong>And let our cry come to you.</strong></p>
        {{ weekly_prayer_html|safe }}
        {% if personal_prayers_list %}
          <p class="subheader"><strong>Your Personal Prayers for this Topic</strong></p>
          <ul>
          {% for prayer in personal_prayers_list %}
            <li>
              {% if prayer.for_whom %}<strong>(For {{ prayer.for_whom }}):</strong> {% endif %}{{ prayer.text }}
            </li>
          {% endfor %}
          </ul>
        {% endif %}
        <p><em>(You may offer your own prayers at this time)</em></p>
        <hr />
        <p class="subheader"><strong>Concluding Prayer</strong></p>
        {{ macros.format_prayer(concluding_prayer) }}
        <hr />
        {{ macros.format_prayer(luthers_evening_prayer) }}
    {% endcall %}

    {% call macros.card('Conclusion') %}
        <p>
          Let us bless the Lord.<br />
          <strong>Thanks be to God.</strong>
        </p>
        <p><span class="rubric">Then go to sleep at once and in good cheer.</span></p>
    {% endcall %}
{% endblock %}

{% block extra_js %}
    let isLectionaryMode = false;
    const officeReadingRef = "{{ reading_ref }}";
    const officeOptions = {{ reading_options|tojson }};
    const lectionaryOptions = {{ daily_lectionary_readings|tojson }};

    function updatePicker(options) {
        const picker = document.getElementById('picker-reading');
        picker.innerHTML = '';
        options.forEach(r => {
            const btn = document.createElement('button');
            btn.className = 'button picker-select-button';
            btn.textContent = r;
            btn.onclick = () => selectRef(r, 'reading');
            picker.appendChild(btn);
        });
    }

    function toggleLectionaryReadings() {
       const btn = document.getElementById('btn-toggle-lectionary');
       if (isLectionaryMode) {
           selectRef(officeReadingRef, 'reading');
           btn.innerText = "Switch to Daily Lectionary";
           isLectionaryMode = false;
           updatePicker(officeOptions);
       } else {
           if(lectionaryOptions.length > 0) {
               selectRef(lectionaryOptions[0], 'reading');
               btn.innerText = "Back to Office Reading";
               isLectionaryMode = true;
               updatePicker(lectionaryOptions);
           } else {
               alert("No Daily Lectionary readings available for today.");
           }
       }
    }
{% endblock %}
