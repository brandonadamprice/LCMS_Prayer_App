{% extends "base.html" %}
{% import "_macros.html" as macros %}

{% block title %}Prayer Reminders{% endblock %}

{% block content %}
<div class="page-header">
  <h1>Prayer Reminders</h1>
  <p>Schedule daily reminders to help you maintain a regular prayer life.</p>
</div>

<div class="card">
    <p>To receive push notifications, please <a href="/settings">enable them in your Settings</a>.</p>
</div>

<div class="card">
  <h2>Add New Reminder</h2>
  <form id="reminder-form">
    <div style="margin-bottom: 10px;">
      <label for="time">Time (15-min intervals):</label><br>
      <input type="time" id="time" name="time" required class="form-input" style="max-width: 150px;" step="900">
    </div>
    
    <div style="margin-bottom: 10px;">
      <label for="devotion">Devotion Type:</label><br>
      <select id="devotion" name="devotion" required class="form-input">
        <option value="morning">Morning Prayer</option>
        <option value="midday">Midday Prayer</option>
        <option value="evening">Evening Prayer</option>
        <option value="close_of_day">Close of the Day</option>
        <option value="night_watch">Night Watch</option>
        <option value="bible_in_a_year">Bible in a Year</option>
      </select>
    </div>

    <div style="margin-bottom: 10px;">
      <label>Notification Methods:</label><br>
      <div style="margin-top: 5px;">
        <input type="checkbox" id="method-push" name="methods" value="push">
        <label for="method-push">Push Notification</label>
      </div>

      <div style="margin-top: 5px; color: #7f8c8d;">
        <input type="checkbox" id="method-sms" name="methods" value="sms" disabled>
        <label for="method-sms">Text Message (SMS) - <em>Coming Soon</em></label>
      </div>
    </div>

    <button type="submit" class="button">Set Reminder</button>
  </form>
</div>



<div class="card">
  <h2>My Active Reminders</h2>
  <div id="reminders-list">
    <p><em>Loading...</em></p>
  </div>
</div>

{% if current_user.id == config['ADMIN_USER_ID'] %}
<div class="card" style="border-color: red;">
    <h2>Admin Debug</h2>
    <p>This button will force <strong>all</strong> of your reminders to fire immediately, regardless of their scheduled time. Use this to test push notifications on your device.</p>
    <button class="button" onclick="forceReminders()" style="background-color: #e74c3c;">Force Send All My Reminders</button>
</div>
<script>
async function forceReminders() {
    if(!confirm("Are you sure? This will send all your reminders now.")) return;
    try {
        const response = await fetch('/debug/force_reminders', {method: 'POST'});
        const data = await response.json();
        if (data.success) {
            alert(data.message);
        } else {
            alert("Error: " + data.error);
        }
    } catch(e) {
        alert("Error: " + e);
    }
}
</script>
{% endif %}
{% endblock %}

{% block extra_js %}
</script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging.js";

  const remindersList = document.getElementById('reminders-list');
  const pushCheckbox = document.getElementById('method-push');
  let messaging = null;
  let cachedConfig = null;

  async function initFirebase() {
    try {
      const response = await fetch('/firebase_config');
      if (!response.ok) throw new Error("Failed to fetch config");
      cachedConfig = await response.json();
      
      const app = initializeApp(cachedConfig);
      messaging = getMessaging(app);
      
      // Handle foreground messages
      onMessage(messaging, (payload) => {
        console.log('Message received. ', payload);
        let title = 'Prayer Reminder';
        let body = '';
        let url = '/';

        if (payload.notification) {
            title = payload.notification.title || title;
            body = payload.notification.body;
        } else if (payload.data) {
            title = payload.data.title || title;
            body = payload.data.body;
            if(payload.data.url) url = payload.data.url;
        }

        const notificationOptions = {
          body: body,
          icon: '/static/favicon.svg',
          data: { url: url }
        };
        new Notification(title, notificationOptions);
      });
      console.log("Firebase initialized");
    } catch(e) {
      console.error("Firebase Init Error", e);
    }
  }

  async function loadReminders() {
    try {
        const response = await fetch('/get_reminders');
        if(!response.ok) throw new Error("Failed to fetch");
        const reminders = await response.json();
        
        if (reminders.length === 0) {
            remindersList.innerHTML = '<p><em>No active reminders.</em></p>';
            return;
        }

        let html = '<ul style="list-style: none; padding: 0;">';
        reminders.forEach(r => {
            const methods = r.methods.join(', ');
            html += `
                <li style="border-bottom: 1px solid #eee; padding: 10px 0; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${r.time}</strong> - ${r.devotion_name}<br>
                        <span style="font-size: 0.9em; color: #666;">Via: ${methods}</span>
                    </div>
                    <button class="button" style="background-color: #e74c3c; padding: 5px 10px; font-size: 0.8em;" onclick="deleteReminder('${r.id}')">Delete</button>
                </li>
            `;
        });
        html += '</ul>';
        remindersList.innerHTML = html;
    } catch (e) {
        console.error(e);
        remindersList.innerHTML = '<p><em>Error loading reminders.</em></p>';
    }
  }



  async function deleteReminder(id) {
    if (!confirm("Delete this reminder?")) return;
    try {
        const response = await fetch('/delete_reminder', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({reminder_id: id})
        });
        if(response.ok) {
            loadReminders();
        } else {
            alert("Failed to delete.");
        }
    } catch(e) {
        alert("Error deleting reminder.");
    }
  }
  
  // Expose to global scope for HTML onclick
  window.deleteReminder = deleteReminder;

  document.getElementById('reminder-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const methods = formData.getAll('methods');
    
    if (methods.length === 0) {
        alert("Please select at least one notification method.");
        return;
    }

    if (methods.includes('push')) {
        if (Notification.permission !== 'granted') {
            alert("Please enable notifications in your Account Settings to receive push reminders.");
            // We allow them to proceed, assuming they might enable it later or have it on another device.
            // But we could also uncheck it.
            // pushCheckbox.checked = false;
        }
    }

    const data = {
        time: formData.get('time'),
        devotion: formData.get('devotion'),
        methods: methods,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
    };

    try {
        const response = await fetch('/add_reminder', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        const result = await response.json();
        if (result.success) {
            e.target.reset();
            loadReminders();
        } else {
            alert("Error: " + result.error);
        }
    } catch(e) {
        console.error(e);
        alert("An error occurred.");
    }
  });

  document.addEventListener('DOMContentLoaded', () => {
      initFirebase();
      loadReminders();
  });
</script>
<script>
{% endblock %}
