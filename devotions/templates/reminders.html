{% extends "base.html" %}
{% import "_macros.html" as macros %}

{% block title %}Prayer Reminders{% endblock %}

{% block content %}
<div class="page-header">
  <h1>Prayer Reminders</h1>
  <p>Schedule daily reminders to help you maintain a regular prayer life.</p>
</div>

<div class="card">
  <h2>Device Setup</h2>
  <p>To receive notifications on this device, please enable them below. This is required even if you have enabled them on other devices.</p>
  <div style="display: flex; align-items: center; gap: 15px; margin-top: 15px;">
    <label class="switch">
        <input type="checkbox" id="notifications-toggle">
        <span class="slider"></span>
    </label>
    <span id="notif-status-text" style="font-weight: bold;">Enable Notifications</span>
  </div>
</div>

<div class="card">
  <h2>Add New Reminder</h2>
  <form id="reminder-form">
    <div style="margin-bottom: 10px;">
      <label for="time">Time (15-min intervals):</label><br>
      <input type="time" id="time" name="time" required class="form-input" style="max-width: 150px;" step="900">
    </div>
    
    <div style="margin-bottom: 10px;">
      <label for="devotion">Devotion Type:</label><br>
      <select id="devotion" name="devotion" required class="form-input">
        <option value="morning">Morning Prayer</option>
        <option value="midday">Midday Prayer</option>
        <option value="evening">Evening Prayer</option>
        <option value="close_of_day">Close of the Day</option>
        <option value="night_watch">Night Watch</option>
        <option value="bible_in_a_year">Bible in a Year</option>
      </select>
    </div>

    <div style="margin-bottom: 10px;">
      <label>Notification Methods:</label><br>
      <div style="margin-top: 5px;">
        <input type="checkbox" id="method-push" name="methods" value="push">
        <label for="method-push">Push Notification</label>
      </div>

      <div style="margin-top: 5px; color: #7f8c8d;">
        <input type="checkbox" id="method-sms" name="methods" value="sms" disabled>
        <label for="method-sms">Text Message (SMS) - <em>Coming Soon</em></label>
      </div>
    </div>

    <button type="submit" class="button">Set Reminder</button>
  </form>
</div>



<div class="card">
  <h2>My Active Reminders</h2>
  <div id="reminders-list">
    <p><em>Loading...</em></p>
  </div>
</div>

{% if current_user.id == config['ADMIN_USER_ID'] %}
<div class="card" style="border-color: red;">
    <h2>Admin Debug</h2>
    <p>This button will force <strong>all</strong> of your reminders to fire immediately, regardless of their scheduled time. Use this to test push notifications on your device.</p>
    <button class="button" onclick="forceReminders()" style="background-color: #e74c3c;">Force Send All My Reminders</button>
</div>
<script>
async function forceReminders() {
    if(!confirm("Are you sure? This will send all your reminders now.")) return;
    try {
        const response = await fetch('/debug/force_reminders', {method: 'POST'});
        const data = await response.json();
        if (data.success) {
            alert(data.message);
        } else {
            alert("Error: " + data.error);
        }
    } catch(e) {
        alert("Error: " + e);
    }
}
</script>
{% endif %}
{% endblock %}

{% block extra_js %}
</script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging.js";

  const remindersList = document.getElementById('reminders-list');
  const pushCheckbox = document.getElementById('method-push');
  let messaging = null;
  let cachedConfig = null;

  async function initFirebase() {
    try {
      const response = await fetch('/firebase_config');
      if (!response.ok) throw new Error("Failed to fetch config");
      cachedConfig = await response.json();
      
      const app = initializeApp(cachedConfig);
      messaging = getMessaging(app);
      
      // Handle foreground messages
      onMessage(messaging, (payload) => {
        console.log('Message received. ', payload);
        let title = 'Prayer Reminder';
        let body = '';
        let url = '/';

        if (payload.notification) {
            title = payload.notification.title || title;
            body = payload.notification.body;
        } else if (payload.data) {
            title = payload.data.title || title;
            body = payload.data.body;
            if(payload.data.url) url = payload.data.url;
        }

        const notificationOptions = {
          body: body,
          icon: '/static/favicon.svg',
          data: { url: url }
        };
        new Notification(title, notificationOptions);
      });
      console.log("Firebase initialized");
    } catch(e) {
      console.error("Firebase Init Error", e);
    }
  }

  async function requestPushPermission() {
    if (!('Notification' in window)) {
        alert("This browser does not support desktop notification");
        return false;
    }
    const permission = await Notification.requestPermission();
    if (permission !== 'granted') {
        alert('Permission not granted for Notification');
        return false;
    }
    
    if (!messaging) await initFirebase();
    if (!messaging) {
        alert("Failed to initialize notification service. Please refresh and try again.");
        return false;
    }

    try {
        const registration = await navigator.serviceWorker.ready;
        const options = {
            serviceWorkerRegistration: registration
        };
        if (cachedConfig && cachedConfig.vapidKey) {
            options.vapidKey = cachedConfig.vapidKey;
        }

        const currentToken = await getToken(messaging, options);
        if (currentToken) {
            await fetch('/save_fcm_token', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({token: currentToken})
            });
            console.log("FCM Token saved");
            return true; 
        } else {
            console.log('No registration token available.');
            return false;
        }
    } catch (err) {
        console.log('An error occurred while retrieving token. ', err);
        return false;
    }
  }

  async function loadReminders() {
    try {
        const response = await fetch('/get_reminders');
        if(!response.ok) throw new Error("Failed to fetch");
        const reminders = await response.json();
        
        if (reminders.length === 0) {
            remindersList.innerHTML = '<p><em>No active reminders.</em></p>';
            return;
        }

        let html = '<ul style="list-style: none; padding: 0;">';
        reminders.forEach(r => {
            const methods = r.methods.join(', ');
            html += `
                <li style="border-bottom: 1px solid #eee; padding: 10px 0; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${r.time}</strong> - ${r.devotion_name}<br>
                        <span style="font-size: 0.9em; color: #666;">Via: ${methods}</span>
                    </div>
                    <button class="button" style="background-color: #e74c3c; padding: 5px 10px; font-size: 0.8em;" onclick="deleteReminder('${r.id}')">Delete</button>
                </li>
            `;
        });
        html += '</ul>';
        remindersList.innerHTML = html;
    } catch (e) {
        console.error(e);
        remindersList.innerHTML = '<p><em>Error loading reminders.</em></p>';
    }
  }

  const notifToggle = document.getElementById('notifications-toggle');
  const notifStatusText = document.getElementById('notif-status-text');

  async function disableNotifications() {
    try {
        if (!messaging) await initFirebase();
        if (!messaging) return;

        const registration = await navigator.serviceWorker.ready;
        const currentToken = await getToken(messaging, { serviceWorkerRegistration: registration });
        
        if (currentToken) {
            await fetch('/remove_fcm_token', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({token: currentToken})
            });
            console.log("Token removed from server.");
        }
        // We do not delete the token from the browser/firebase client itself, 
        // as deleteToken() is often unreliable or not what we want (we might re-enable later).
        // Removing from server stops the notifications.
    } catch(e) {
        console.error("Error disabling notifications:", e);
    }
  }

  function updateToggleState() {
    if (!('Notification' in window)) {
        if(notifToggle) notifToggle.disabled = true;
        if(notifStatusText) notifStatusText.textContent = "Notifications not supported";
        return;
    }

    const localEnabled = localStorage.getItem('notifications_enabled') === 'true';

    if (Notification.permission === 'granted') {
        if (localEnabled) {
            if(notifToggle) notifToggle.checked = true;
            if(notifStatusText) notifStatusText.textContent = "Notifications Enabled";
        } else {
            // Permission granted but user disabled in app (or hasn't enabled yet in this session logic)
            // We treat this as disabled.
            if(notifToggle) notifToggle.checked = false;
            if(notifStatusText) notifStatusText.textContent = "Enable Notifications";
        }
    } else if (Notification.permission === 'denied') {
        if(notifToggle) {
            notifToggle.checked = false;
            notifToggle.disabled = true;
        }
        if(notifStatusText) notifStatusText.textContent = "Notifications Denied (Check Browser Settings)";
        localStorage.setItem('notifications_enabled', 'false'); // Force false
    } else {
        // Default / Prompt state
        if(notifToggle) notifToggle.checked = false;
        if(notifStatusText) notifStatusText.textContent = "Enable Notifications";
        localStorage.setItem('notifications_enabled', 'false'); // Force false
    }
  }

  if (notifToggle) {
      notifToggle.addEventListener('change', async (e) => {
        if (e.target.checked) {
            const granted = await requestPushPermission();
            if (granted) {
                notifStatusText.textContent = "Notifications Enabled";
                localStorage.setItem('notifications_enabled', 'true');
            } else {
                e.target.checked = false;
                updateToggleState(); // Re-evaluate state
            }
        } else {
            // User disabling via toggle
            await disableNotifications();
            localStorage.setItem('notifications_enabled', 'false');
            notifStatusText.textContent = "Enable Notifications";
        }
      });
  }

  async function deleteReminder(id) {
    if (!confirm("Delete this reminder?")) return;
    try {
        const response = await fetch('/delete_reminder', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({reminder_id: id})
        });
        if(response.ok) {
            loadReminders();
        } else {
            alert("Failed to delete.");
        }
    } catch(e) {
        alert("Error deleting reminder.");
    }
  }
  
  // Expose to global scope for HTML onclick
  window.deleteReminder = deleteReminder;

  document.getElementById('reminder-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const methods = formData.getAll('methods');
    
    if (methods.length === 0) {
        alert("Please select at least one notification method.");
        return;
    }

    if (methods.includes('push')) {
        const granted = await requestPushPermission();
        if (!granted) {
            pushCheckbox.checked = false; 
            if(methods.length === 1) return;
        }
    }

    const data = {
        time: formData.get('time'),
        devotion: formData.get('devotion'),
        methods: methods,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
    };

    try {
        const response = await fetch('/add_reminder', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        const result = await response.json();
        if (result.success) {
            e.target.reset();
            loadReminders();
        } else {
            alert("Error: " + result.error);
        }
    } catch(e) {
        console.error(e);
        alert("An error occurred.");
    }
  });

  document.addEventListener('DOMContentLoaded', () => {
      initFirebase();
      loadReminders();
      updateToggleState();
  });
</script>
<script>
{% endblock %}
