{% extends "base.html" %}
{% import "_macros.html" as macros %}

{% block title %}Prayer Reminders{% endblock %}

{% block content %}
<div class="page-header">
  <h1>Prayer Reminders</h1>
  <p>Schedule daily reminders to help you maintain a regular prayer life.</p>
</div>

<div class="card">
    <p>To receive push notifications, please <a href="/settings">enable them in your Settings</a>.</p>
</div>

<div class="card">
  <h2>Add New Reminder</h2>
  <form id="reminder-form">
    <div style="margin-bottom: 10px;">
      <label for="time">Time (15-min intervals):</label><br>
      <input type="time" id="time" name="time" required class="form-input" style="max-width: 150px;" step="900">
    </div>
    
    <div style="margin-bottom: 10px;">
      <label for="devotion">Devotion Type:</label><br>
      <select id="devotion" name="devotion" required class="form-input">
        <option value="morning">Morning Prayer</option>
        <option value="midday">Midday Prayer</option>
        <option value="evening">Evening Prayer</option>
        <option value="close_of_day">Close of the Day</option>
        <option value="night_watch">Night Watch</option>
        <option value="bible_in_a_year">Bible in a Year</option>
        <option value="lent">Lenten Devotion</option>
      </select>
    </div>
    
    <div id="reading-type-group" style="margin-bottom: 10px; display: none;">
      <label for="reading_type">Reading Type:</label><br>
      <select id="reading_type" name="reading_type" class="form-input">
        <option value="office">Office Reading (Rotating)</option>
        <option value="lectionary">Daily Lectionary (Church Year)</option>
      </select>
    </div>

    <p style="font-size: 0.9em; color: #7f8c8d; margin-bottom: 5px;">
        Notification preferences (Push, Email, SMS) can be configured in your <a href="/settings">Settings</a>.
    </p>
    <p style="font-size: 0.85em; color: #7f8c8d; margin-bottom: 15px;">
        Email reminders are sent from <strong>asimplewaytopray@gmail.com</strong>.<br>
        SMS reminders are sent from <strong>+1 (844) 314-5905</strong>.
    </p>

    <button type="submit" class="button">Set Reminder</button>
  </form>
</div>



<div class="card">
  <h2>My Active Reminders</h2>
  <div id="reminders-list">
    <p><em>Loading...</em></p>
  </div>
</div>

{% if current_user.id == config['ADMIN_USER_ID'] %}
<div class="card" style="border-color: red;">
    <h2>Admin Debug</h2>
    <p>This button will force <strong>all</strong> of your reminders to fire immediately, regardless of their scheduled time. Use this to test push notifications on your device.</p>
    <button class="button" onclick="forceReminders()" style="background-color: #e74c3c;">Force Send All My Reminders</button>
</div>
<script>
async function forceReminders() {
    if(!confirm("Are you sure? This will send all your reminders now.")) return;
    try {
        const response = await fetch('/debug/force_reminders', {method: 'POST'});
        const data = await response.json();
        if (data.success) {
            alert(data.message);
        } else {
            alert("Error: " + data.error);
        }
    } catch(e) {
        alert("Error: " + e);
    }
}
</script>
{% endif %}
{% endblock %}

{% block extra_js %}
</script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging.js";

  const remindersList = document.getElementById('reminders-list');
  let messaging = null;
  let cachedConfig = null;

  async function initFirebase() {
    try {
      const response = await fetch('/firebase_config');
      if (!response.ok) throw new Error("Failed to fetch config");
      cachedConfig = await response.json();
      
      const app = initializeApp(cachedConfig);
      messaging = getMessaging(app);
      
      // Handle foreground messages
      onMessage(messaging, (payload) => {
        console.log('Message received. ', payload);
        let title = 'Prayer Reminder';
        let body = '';
        let url = '/';

        if (payload.notification) {
            title = payload.notification.title || title;
            body = payload.notification.body;
        } else if (payload.data) {
            title = payload.data.title || title;
            body = payload.data.body;
            if(payload.data.url) url = payload.data.url;
        }

        const notificationOptions = {
          body: body,
          icon: '/static/favicon.svg',
          data: { url: url }
        };
        new Notification(title, notificationOptions);
      });
      console.log("Firebase initialized");
    } catch(e) {
      console.error("Firebase Init Error", e);
    }
  }

  async function loadReminders() {
    try {
        const response = await fetch('/get_reminders');
        if(!response.ok) throw new Error("Failed to fetch");
        const reminders = await response.json();
        
        if (reminders.length === 0) {
            remindersList.innerHTML = '<p><em>No active reminders.</em></p>';
            return;
        }

        let html = '<ul style="list-style: none; padding: 0;">';
        reminders.forEach(r => {
            let details = r.devotion_name;
            if (r.reading_type === 'lectionary') {
                details += ' (Daily Lectionary)';
            } else if (r.reading_type === 'office') {
                details += ' (Office Reading)';
            }
            
            html += `
                <li style="border-bottom: 1px solid #eee; padding: 10px 0; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${r.time}</strong> - ${details}
                    </div>
                    <button class="button" style="background-color: #e74c3c; padding: 5px 10px; font-size: 0.8em;" onclick="deleteReminder('${r.id}')">Delete</button>
                </li>
            `;
        });
        html += '</ul>';
        remindersList.innerHTML = html;
    } catch (e) {
        console.error(e);
        remindersList.innerHTML = '<p><em>Error loading reminders.</em></p>';
    }
  }



  async function deleteReminder(id) {
    if (!confirm("Delete this reminder?")) return;
    try {
        const response = await fetch('/delete_reminder', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({reminder_id: id})
        });
        if(response.ok) {
            loadReminders();
        } else {
            alert("Failed to delete.");
        }
    } catch(e) {
        alert("Error deleting reminder.");
    }
  }
  
  // Expose to global scope for HTML onclick
  window.deleteReminder = deleteReminder;
  
  const devotionSelect = document.getElementById('devotion');
  const readingTypeGroup = document.getElementById('reading-type-group');
  
  function updateReadingTypeVisibility() {
      const val = devotionSelect.value;
      if (['morning', 'midday', 'evening', 'close_of_day', 'night_watch'].includes(val)) {
          readingTypeGroup.style.display = 'block';
      } else {
          readingTypeGroup.style.display = 'none';
      }
  }
  
  devotionSelect.addEventListener('change', updateReadingTypeVisibility);

  document.getElementById('reminder-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    
    // Check global permission status for awareness, though backend handles the actual sending based on prefs.
    if (Notification.permission !== 'granted') {
        // We can just warn or let them proceed. The link at top already directs them.
    }

    // We default to 'push' for now in the backend call, but the backend 
    // now also checks user preferences. We send 'push' as a requested method
    // to keep the API contract, and 'sms' if we want to support it implicitly 
    // based on settings, but the previous API expected a list of methods.
    // Let's send 'push', 'email' and 'sms' as requested methods, 
    // and let the backend filter based on user preferences.
    const methods = ['push', 'email', 'sms'];

    const data = {
        time: formData.get('time'),
        devotion: formData.get('devotion'),
        methods: methods,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
    };
    
    // Include reading type if visible
    if (readingTypeGroup.style.display !== 'none') {
        data.reading_type = formData.get('reading_type');
    }

    try {
        const response = await fetch('/add_reminder', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        const result = await response.json();
        if (result.success) {
            e.target.reset();
            updateReadingTypeVisibility();
            loadReminders();
        } else {
            alert("Error: " + result.error);
        }
    } catch(e) {
        console.error(e);
        alert("An error occurred.");
    }
  });

  document.addEventListener('DOMContentLoaded', () => {
      initFirebase();
      loadReminders();
      updateReadingTypeVisibility();

      // Auto-populate from URL params
      const urlParams = new URLSearchParams(window.location.search);
      const timeParam = urlParams.get('time');
      const devotionParam = urlParams.get('devotion');
      
      if (timeParam) {
          const timeInput = document.getElementById('time');
          if (timeInput) timeInput.value = timeParam;
      }
      
      if (devotionParam) {
          if (devotionSelect) {
              devotionSelect.value = devotionParam;
              updateReadingTypeVisibility();
          }
      }
  });
</script>
<script>
{% endblock %}
