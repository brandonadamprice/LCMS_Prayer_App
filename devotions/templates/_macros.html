{% macro card(title, collapsed=False) %}
<div class="card{% if collapsed %} collapsed{% endif %}">
  <div class="card-header" onclick="toggleCard(this)">
    <h2>{{ title|safe }}</h2>
    <span class="toggle-icon">â–¼</span>
  </div>
  <div class="card-content">
    {{ caller() }}
  </div>
</div>
{% endmacro %}

{% macro format_prayer(prayer_obj) %}
{% if prayer_obj.display_title %}
<p class="subheader"><strong>{{ prayer_obj.prayer_title }}</strong></p>
{% endif %}
<p>
  <strong>{{ prayer_obj.prayer | replace('\n', '<br />') | safe }}</strong>
  {% if prayer_obj.reference %}
    <span class="versicle-ref">{{ prayer_obj.reference }}</span>
  {% endif %}
</p>
{% endmacro %}

{% macro personal_prayers_toggle(all_personal_prayers) %}
{% if all_personal_prayers %}
<button class="button" onclick="togglePersonalPrayers(this)">Show My Personal Prayers</button>
<div id="personal-prayers-list" class="hidden" style="margin-top: 10px;">
  <p class="subheader"><strong>My Personal Prayers</strong></p>
  {% for category, prayers in all_personal_prayers.items() %}
    {% if prayers %}
      <p><strong>{{ category }}</strong></p>
      <ul>
        {% for prayer in prayers %}
        <li>
          {% if prayer.for_whom %}<strong>(For {{ prayer.for_whom }}):</strong> {% endif %}{{ prayer.text }}
        </li>
        {% endfor %}
      </ul>
    {% endif %}
  {% endfor %}
</div>
{% endif %}
{% endmacro %}

{% macro prayer_complete_button(devotion_type) %}
{% if current_user.is_authenticated %}
{% set is_completed = current_user.completed_devotions and current_user.completed_devotions.get(devotion_type) and current_user.completed_devotions.get(devotion_type).startswith(today_ymd) %}
<div style="text-align: center; margin-top: 30px; margin-bottom: 20px;">
    {% if is_completed %}
    <button class="button" disabled style="background-color: #95a5a6; cursor: not-allowed; font-size: 1.1em; padding: 12px 24px;">
        <span style="margin-right: 8px;">âœ“</span> Completed
    </button>
    <p style="color: #7f8c8d; font-weight: bold; margin-top: 10px;">You have already completed this devotion today.</p>
    {% else %}
    <button id="btn-complete-prayer" class="button" onclick="markPrayerComplete('{{ devotion_type }}')" style="background-color: #27ae60; font-size: 1.1em; padding: 12px 24px;">
        <span style="margin-right: 8px;">ðŸ”¥</span> Mark Prayer Complete
    </button>
    <p id="prayer-complete-msg" style="color: #27ae60; font-weight: bold; display: none; margin-top: 10px;">Prayer recorded!</p>
    {% endif %}
</div>
<script>
{% if not is_completed %}
async function markPrayerComplete(devotionType) {
    const btn = document.getElementById('btn-complete-prayer');
    const msg = document.getElementById('prayer-complete-msg');
    
    if (btn) btn.disabled = true;
    
    try {
        const response = await fetch('/api/complete_prayer', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ devotion_type: devotionType })
        });
        const data = await response.json();
        
        if (data.streak !== undefined) {
            // Update UI
            if (msg) {
                msg.style.display = 'block';
                if (data.message) {
                    msg.textContent = data.message;
                } else if (data.already_prayed) {
                    msg.textContent = "You've already prayed today! Streak: " + data.streak;
                } else {
                    msg.textContent = "Prayer recorded! Current Streak: " + data.streak + " days";
                }
            }
            if (btn) {
                // Change button to grayed out state immediately
                btn.style.backgroundColor = "#95a5a6";
                btn.style.cursor = "not-allowed";
                btn.innerHTML = '<span style="margin-right: 8px;">âœ“</span> Completed';
                // We keep it disabled as set above
            }
            
            // Update nav counter if it exists
            const navStreak = document.getElementById('nav-streak-count');
            if (navStreak) navStreak.textContent = data.streak;
            
            // Handle milestone
            if (data.milestone_reached) {
                showMilestonePopup(data.milestone_msg, data.streak);
            }
        }
    } catch (e) {
        console.error("Error marking prayer complete:", e);
        if (btn) btn.disabled = false;
        alert("Failed to record prayer. Please check your connection.");
    }
}
{% endif %}

function showMilestonePopup(message, streak) {
    // Create modal HTML dynamically if not present, or use a hidden one in base
    // We'll rely on a global function defined in base.html for the modal
    if (window.triggerMilestoneModal) {
        window.triggerMilestoneModal(message, streak);
    } else {
        alert("Congratulations! " + message);
    }
}
</script>
{% endif %}
{% endmacro %}
