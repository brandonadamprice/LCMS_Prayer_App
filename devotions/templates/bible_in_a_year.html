{% extends parent_template|default("base.html") %}
{% import "_macros.html" as macros with context %}

{% block title %}Bible in a Year{% endblock %}

{% block head %}
<style>
    .catch-up-box {
        margin-top: 20px;
        background-color: #e8f6f3;
        border: 1px solid #27ae60;
    }
    body.dark-mode .catch-up-box {
        background-color: #1b4d2e;
        border-color: #2e7d32;
        color: #e0e0e0;
    }
    .progress-label {
        font-weight: bold;
        color: #555;
    }
    body.dark-mode .progress-label {
        color: #ccc;
    }
</style>
{% endblock %}

{% block content %}
    <div class="page-header">
      <h1>Bible in a Year</h1>
      <h2>A 365-Day reading plan featuring a mix of Old Testament, New Testament, and Psalms & Proverbs.</h2>
      <p>Readings for Day <span id="day-display">{{ day_number|default(1) }}</span> of 365</p>
      <div>
        <button class="button" onclick="changeDay(-1)">Prev Day</button>
        <label for="day-select">Jump to Day:</label>
        <select id="day-select" onchange="jumpToDay(this.value)" style="padding: 5px; border-radius: 4px; border: 1px solid #ccc; margin: 0 5px;">
          {% for i in range(1, 366) %}
            <option value="{{ i }}">{{ i }}</option>
          {% endfor %}
        </select>
        <button class="button" onclick="changeDay(1)">Next Day</button>
      </div>
    </div>

    {% call macros.card('Old Testament') %}
        <span class="ref" id="ot-ref">{{ ot_ref }}</span>
        <p id="ot-text">{% if ot_text %}{{ ot_text|safe }}{% else %}<em>Loading...</em>{% endif %}</p>
    {% endcall %}

    {% call macros.card('New Testament') %}
        <span class="ref" id="nt-ref">{{ nt_ref }}</span>
        <p id="nt-text">{% if nt_text %}{{ nt_text|safe }}{% else %}<em>Loading...</em>{% endif %}</p>
    {% endcall %}

    {% call macros.card('Psalms & Proverbs') %}
        <span class="ref" id="psp-ref">{{ psp_ref }}</span>
        <p id="psp-text">{% if psp_text %}{{ psp_text|safe }}{% else %}<em>Loading...</em>{% endif %}</p>
    {% endcall %}
    
    {% if current_user.is_authenticated %}
    <div class="card" style="text-align: center;">
        <div style="margin-bottom: 20px;">
            <p class="progress-label">Your Bible Reading Progress</p>
            <div style="background-color: #eee; border-radius: 10px; height: 20px; overflow: hidden; max-width: 400px; margin: 0 auto;">
                <div id="progress-bar" style="background-color: #2980b9; width: 0%; height: 100%; transition: width 0.5s ease; text-align: center; color: white; font-size: 0.8em; line-height: 20px;">0%</div>
            </div>
            <p style="font-size: 0.9em; color: #7f8c8d; margin-top: 5px;">
                Bible Streak: <strong id="bible-streak-display" style="color: #e67e22;">{{ bible_streak }}</strong> Days
            </p>
        </div>

        <button id="btn-mark-complete" class="button" onclick="markReadingComplete()" style="background-color: #27ae60; font-size: 1.1em; padding: 12px 24px;">
             Mark Reading as Complete
        </button>
        <p id="completion-msg" style="color: #27ae60; font-weight: bold; display: none; margin-top: 10px;"></p>
        
        <div id="catch-up-container" class="card catch-up-box" style="display:none;">
            <p style="margin-top: 0;"><strong>Catch Up Available</strong></p>
            <p id="catch-up-msg">It looks like you're on day {{ day_number|default(1) }}, but some of your older readings haven't been marked as completed. Would you like to mark them all as completed?</p>
            <button class="button" onclick="catchUpReadings()" style="background-color: #27ae60;">Mark All Previous As Completed</button>
            <button class="button" onclick="dismissCatchUp()" style="background-color: #7f8c8d; margin-left: 10px;">Dismiss</button>
        </div>
    </div>
    {% else %}
    <div class="card" style="text-align: center;">
        <p>Log in to track your Bible reading progress and streaks!</p>
        <a href="/login" class="button">Log In</a>
    </div>
    {% endif %}

{% endblock %}

{% block extra_js %}
window.suppressDefaultArt = true;
const schedule = JSON.parse('{{ schedule|safe }}');
const completedDays = JSON.parse('{{ completed_days|safe }}');
const dayDisplay = document.getElementById('day-display');
const daySelect = document.getElementById('day-select');
const otRef = document.getElementById('ot-ref');
const otText = document.getElementById('ot-text');
const ntRef = document.getElementById('nt-ref');
const ntText = document.getElementById('nt-text');
const pspRef = document.getElementById('psp-ref');
const pspText = document.getElementById('psp-text');

const isAuthenticated = {{ current_user.is_authenticated|tojson }};
const serverProgress = JSON.parse('{{ bia_progress|safe }}');

let currentDay = 1;

function getTodayDateString() {
    const now = new Date();
    return now.getFullYear() + '-' + (now.getMonth() + 1) + '-' + now.getDate();
}

async function fetchPassage(ref, textElement) {
    textElement.innerHTML = '<em>Loading...</em>';
    try {
        const response = await fetch('/get_passage_text?ref=' + encodeURIComponent(ref));
        if (!response.ok) throw new Error('Network response was not ok for ' + ref);
        const data = await response.json();
        textElement.innerHTML = data.text;
    } catch (error) {
        console.error('Error fetching passage:', error);
        textElement.innerHTML = '<em>Error loading passage for ' + ref + '.</em>';
    }
}

function loadReadingsForDay(day) {
    const dayData = schedule[day - 1];
    if (!dayData) return;

    currentDay = day;
    dayDisplay.textContent = day;
    daySelect.value = day;

    otRef.textContent = dayData["Old Testament"];
    ntRef.textContent = dayData["New Testament"];
    pspRef.textContent = dayData["Psalms & Proverbs"];

    fetchPassage(dayData["Old Testament"], otText);
    fetchPassage(dayData["New Testament"], ntText);
    fetchPassage(dayData["Psalms & Proverbs"], pspText);

    saveProgress(day);
    updateCompletionUI();

    // Fetch background art based on NT reading
    fetchArt(dayData["New Testament"]);
}

function updateCompletionUI() {
    if (!isAuthenticated) return;
    
    const btn = document.getElementById('btn-mark-complete');
    const msg = document.getElementById('completion-msg');
    const progressBar = document.getElementById('progress-bar');
    
    // Update Progress Bar
    const totalDays = 365;
    const completedCount = completedDays.length;
    let pct = Math.round((completedCount / totalDays) * 100);
    
    // Ensure visibility for small progress
    let displayWidth = pct;
    if (completedCount > 0 && pct < 1) {
         displayWidth = 1; // Min 1% width
         if (pct === 0) pct = "<1"; // Show <1% text
    }
    
    if(progressBar) {
        progressBar.style.width = displayWidth + '%';
        progressBar.textContent = pct + '%';
    }

    // Update Button State
    if (completedDays.includes(currentDay)) {
        if(btn) {
            btn.innerHTML = '<span style="margin-right: 8px;">âœ“</span> Completed';
            btn.style.backgroundColor = "#95a5a6";
            btn.disabled = true;
            btn.style.cursor = "not-allowed";
        }
        if(msg) msg.style.display = 'none';
    } else {
        if(btn) {
            btn.innerHTML = 'Mark Reading as Complete';
            btn.style.backgroundColor = "#27ae60";
            btn.disabled = false;
            btn.style.cursor = "pointer";
        }
        if(msg) msg.style.display = 'none';
    }
    
    checkCatchUp();
}

function checkCatchUp() {
    if (!isAuthenticated) return;
    const container = document.getElementById('catch-up-container');
    if (!container) return;
    
    if (localStorage.getItem('catchUpDismissed') === 'true') {
        container.style.display = 'none';
        return;
    }

    if (currentDay > 1) {
        let missing = false;
        for (let i = 1; i < currentDay; i++) {
            if (!completedDays.includes(i)) {
                missing = true;
                break;
            }
        }
        if (missing) {
             const txt = document.getElementById('catch-up-msg');
             if(txt) txt.textContent = `It looks like you're on day ${currentDay}, but some of your older readings haven't been marked as completed. Would you like to mark them all as completed?`;
             container.style.display = 'block';
        } else {
             container.style.display = 'none';
        }
    } else {
        container.style.display = 'none';
    }
}

async function catchUpReadings() {
    if (!confirm("Are you sure you want to mark all previous days as completed?")) return;
    
    const missingDays = [];
    for (let i = 1; i < currentDay; i++) {
        if (!completedDays.includes(i)) {
            missingDays.push(i);
        }
    }
    
    if (missingDays.length === 0) return;

    try {
        const response = await fetch('/api/catch_up_bible_readings', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ days: missingDays })
        });
        const result = await response.json();
        
        if (result.success) {
            missingDays.forEach(d => {
                if(!completedDays.includes(d)) completedDays.push(d);
            });
            completedDays.sort((a,b) => a-b);
            
            updateCompletionUI();
            
            if (result.new_achievements > 0) {
                 if (window.triggerMilestoneModal) {
                     window.triggerMilestoneModal("You've unlocked new Bible reading achievements!", "N/A");
                } else {
                     alert("You've unlocked new Bible reading achievements!");
                }
            } else {
                alert("Readings updated successfully!");
            }
        } else {
            alert("Error: " + (result.error || "Unknown error"));
        }
    } catch(e) {
        console.error(e);
        alert("Failed to update readings.");
    }
}

function dismissCatchUp() {
    const container = document.getElementById('catch-up-container');
    if(container) container.style.display = 'none';
    localStorage.setItem('catchUpDismissed', 'true');
}

async function markReadingComplete() {
    const btn = document.getElementById('btn-mark-complete');
    const msg = document.getElementById('completion-msg');
    const streakDisplay = document.getElementById('bible-streak-display');
    
    if(btn) btn.disabled = true;
    
    try {
        const response = await fetch('/api/complete_bible_reading', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ day: currentDay })
        });
        const result = await response.json();
        
        if (result.bible_streak !== undefined) {
            // Update local state
            if (!completedDays.includes(currentDay)) {
                completedDays.push(currentDay);
            }
            
            updateCompletionUI();
            
            if(streakDisplay) streakDisplay.textContent = result.bible_streak;
            
            if(msg) {
                msg.style.display = 'block';
                msg.textContent = "Reading recorded!";
            }
            
            if (result.milestone_reached) {
                if (window.triggerMilestoneModal) {
                     window.triggerMilestoneModal(result.milestone_msg, result.bible_streak);
                } else {
                     alert(result.milestone_msg);
                }
            }
        } else {
            alert("Error: " + (result.error || "Unknown error"));
            if(btn) btn.disabled = false;
        }
    } catch(e) {
        console.error(e);
        alert("Failed to mark complete.");
        if(btn) btn.disabled = false;
    }
}

async function fetchArt(ref) {
    const theme = "Scripture";
    try {
        const response = await fetch(`/api/lectionary/art?ref=${encodeURIComponent(ref)}&theme=${encodeURIComponent(theme)}`);
        const data = await response.json();
        if (data && data.image_url) {
            displayBackgroundArt(data);
        }
    } catch (e) {
        console.error("Failed to fetch background art", e);
    }
}

function saveProgress(day) {
    const todayStr = getTodayDateString();
    if (isAuthenticated) {
        fetch('/save_bia_progress', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({day: day, last_visit: todayStr})
        }).catch(err => console.error("Failed to save progress to server:", err));
    } else {
        localStorage.setItem('bibleInYearDay', day);
        localStorage.setItem('bibleInYearLastVisit', todayStr);
    }
}

function loadProgress() {
    const today = new Date();
    today.setHours(0,0,0,0);
    let dayToLoad = 1;
    let savedDay = null;
    let lastVisitStr = null;

    if (isAuthenticated && serverProgress && serverProgress.current_day && serverProgress.last_visit_str) {
        savedDay = serverProgress.current_day;
        lastVisitStr = serverProgress.last_visit_str;
        console.log("Loading progress from server:", savedDay, lastVisitStr);
    } else if (!isAuthenticated) {
        savedDay = localStorage.getItem('bibleInYearDay');
        lastVisitStr = localStorage.getItem('bibleInYearLastVisit');
        console.log("Loading progress from localStorage:", savedDay, lastVisitStr);
    }

    if (savedDay && lastVisitStr) {
        dayToLoad = parseInt(savedDay, 10);
        try {
            const parts = lastVisitStr.split('-').map(p => parseInt(p, 10));
            const lastVisitDate = new Date(parts[0], parts[1]-1, parts[2]);
            lastVisitDate.setHours(0,0,0,0);

            if (today > lastVisitDate) {
                dayToLoad = (dayToLoad % 365) + 1;
            }
        } catch(e) {
            console.error('Could not parse last visit date:', lastVisitStr, e);
        }
    }
    loadReadingsForDay(dayToLoad);
}

function changeDay(delta) {
    let newDay = currentDay + delta;
    if (newDay < 1) newDay = 365;
    if (newDay > 365) newDay = 1;
    loadReadingsForDay(newDay);
}

function jumpToDay(dayStr) {
    const day = parseInt(dayStr, 10);
    if (day >= 1 && day <= 365) {
        loadReadingsForDay(day);
    }
}

document.addEventListener('DOMContentLoaded', loadProgress);

{% endblock %}
