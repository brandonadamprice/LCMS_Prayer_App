{% extends "base.html" %}
{% block title %}Traffic Analytics (GA4){% endblock %}
{% block body_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
{% endblock %}

{% block content %}
<div class="page-header">
  <h1>Website Traffic (GA4)</h1>
  <p>Data pulled directly from Google Analytics 4.</p>
</div>

<div class="card">
    <h2>Total Registered Users</h2>
    <p style="font-size: 2em; font-weight: bold; color: #2980b9; margin: 10px 0;">
        {{ registered_user_count }}
    </p>
    <p style="color: #7f8c8d; font-size: 0.9em;">Users who have signed in at least once.</p>
</div>

<div class="card">
    <h2>Active Users (Last 30 Minutes)</h2>
    <p style="font-size: 2em; font-weight: bold; color: #27ae60; margin: 10px 0;">
        {{ realtime_users }}
    </p>
    <p style="color: #7f8c8d; font-size: 0.9em;">Real-time active users on the site.</p>
</div>

<div class="card">
    <h2>Registered Users List</h2>
    <div style="max-height: 300px; overflow-y: auto; border: 1px solid #eee; border-radius: 4px;">
        <table class="analytics-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th style="text-align: right;">Last Login (EST)</th>
                </tr>
            </thead>
            <tbody>
                {% for user in registered_users %}
                <tr>
                    <td>{{ user.name }}</td>
                    <td>{{ user.email }}</td>
                    <td style="text-align: right;">{{ user.last_login }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% if error %}
<div class="card" style="border-left: 5px solid #e74c3c;">
    <h2>Connection Error</h2>
    <p>Could not fetch data from Google Analytics.</p>
    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 0.9em; overflow-x: auto;">
        {{ error }}
    </div>
    <hr>
    <h3>How to Fix:</h3>
    <ol>
        <li>Go to <strong>Google Analytics Admin</strong> > <strong>Property Settings</strong> > <strong>Property Access Management</strong>.</li>
        <li>Click <strong>+</strong> then <strong>Add users</strong>.</li>
        <li>Add this Service Account email with <strong>Viewer</strong> role:</li>
    </ol>
    <div style="background: #e8f6f3; padding: 10px; border: 1px solid #27ae60; border-radius: 4px; font-weight: bold; text-align: center;">
        {{ service_email }}
    </div>
    <p style="margin-top: 10px;">Also ensure the <code>GA4_PROPERTY_ID</code> secret is set correctly in Secret Manager.</p>
</div>
{% else %}

<div class="card">
    <h2>Traffic Overview (Last 21 Days)</h2>
    <canvas id="traffic-chart" style="max-height: 400px;"></canvas>
</div>

<div style="display: flex; gap: 20px; flex-wrap: wrap;">
    <div class="card" style="flex: 1; min-width: 300px;">
        <h2>User Retention (Last 28 Days)</h2>
        <div style="max-width: 300px; margin: 0 auto;">
            <canvas id="retention-chart"></canvas>
        </div>
    </div>
    <div class="card" style="flex: 1; min-width: 300px;">
        <h2>Time of Day (Last 30 Days)</h2>
        <canvas id="hourly-chart"></canvas>
    </div>
</div>

<div class="card">
    <h2>Top Pages (Last 30 Days)</h2>
    <table class="analytics-table">
        <thead>
            <tr>
                <th>Page Title</th>
                <th>Path</th>
                <th style="text-align: right;">Views</th>
            </tr>
        </thead>
        <tbody>
            {% for page in top_pages %}
            <tr>
                <td>{{ page.title }}</td>
                <td><a href="{{ page.path }}" target="_blank">{{ page.path }}</a></td>
                <td style="text-align: right;">{{ page.views }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    const trafficData = {{ daily_traffic|tojson }};
    const retentionData = {{ retention_data|tojson }};
    const hourlyData = {{ hourly_data|tojson }};
    
    const isDarkMode = document.body.classList.contains('dark-mode');
    const textColor = isDarkMode ? '#ccc' : '#4a4a4a';
    const gridColor = isDarkMode ? '#555' : '#eee';

    if (trafficData && trafficData.length > 0) {
        const ctx = document.getElementById('traffic-chart').getContext('2d');
        const labels = trafficData.map(d => d.date);
        const users = trafficData.map(d => d.users);
        const views = trafficData.map(d => d.views);

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Active Users',
                        data: users,
                        borderColor: '#2980b9',
                        backgroundColor: 'rgba(41, 128, 185, 0.2)',
                        tension: 0.3,
                        fill: true
                    },
                    {
                        label: 'Page Views',
                        data: views,
                        borderColor: '#27ae60',
                        backgroundColor: 'rgba(39, 174, 96, 0.1)',
                        tension: 0.3,
                        borderDash: [5, 5]
                    }
                ]
            },
            options: {
                responsive: true,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { color: textColor },
                        grid: { color: gridColor }
                    },
                    x: {
                        ticks: { color: textColor },
                        grid: { color: gridColor }
                    }
                },
                plugins: {
                    legend: { labels: { color: textColor } }
                }
            }
        });
    }

    if (retentionData) {
        const ctxRet = document.getElementById('retention-chart').getContext('2d');
        new Chart(ctxRet, {
            type: 'pie',
            data: {
                labels: ['New Users', 'Returning Users'],
                datasets: [{
                    data: [retentionData.new || 0, retentionData.returning || 0],
                    backgroundColor: ['#27ae60', '#2980b9'],
                    borderWidth: 1
                }]
            },
            options: {
                plugins: {
                    legend: { labels: { color: textColor } }
                }
            }
        });
    }

    if (hourlyData) {
        const ctxHr = document.getElementById('hourly-chart').getContext('2d');
        const hourLabels = Array.from({length: 24}, (_, i) => i + ":00");
        new Chart(ctxHr, {
            type: 'bar',
            data: {
                labels: hourLabels,
                datasets: [{
                    label: 'Users by Time of Day',
                    data: hourlyData,
                    backgroundColor: '#f1c40f',
                    borderRadius: 4
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { color: textColor },
                        grid: { color: gridColor }
                    },
                    x: {
                        ticks: { color: textColor },
                        grid: { display: false }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }
</script>
{% endif %}

<div class="card">
    <p style="text-align: center;">
        <a href="https://analytics.google.com/" target="_blank" class="button">Open Full GA4 Dashboard</a>
    </p>
</div>
{% endblock %}
