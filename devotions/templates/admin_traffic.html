{% extends "base.html" %}
{% block title %}Traffic Analytics (GA4){% endblock %}
{% block body_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
{% endblock %}

{% block content %}
<div class="page-header">
  <h1>Website Traffic (GA4)</h1>
  <p>Data pulled directly from Google Analytics 4.</p>
</div>

<div class="card">
    <h2>Total Registered Users</h2>
    <p style="font-size: 2em; font-weight: bold; color: #2980b9; margin: 10px 0;">
        {{ registered_user_count }}
    </p>
    <p style="color: #7f8c8d; font-size: 0.9em;">Users who have signed in at least once.</p>
</div>

<div class="card">
    <h2>Active Users (Last 30 Minutes)</h2>
    <p style="font-size: 2em; font-weight: bold; color: #27ae60; margin: 10px 0;">
        {{ realtime_users }}
    </p>
    <p style="color: #7f8c8d; font-size: 0.9em;">Real-time active users on the site.</p>
</div>

<div class="card">
    <h2>Registered Users List</h2>
    <div style="max-height: 300px; overflow-y: auto; border: 1px solid #eee; border-radius: 4px;">
        <table class="analytics-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th style="text-align: right;">Last Login (EST)</th>
                </tr>
            </thead>
            <tbody>
                {% for user in registered_users %}
                <tr>
                    <td>{{ user.name }}</td>
                    <td>{{ user.email }}</td>
                    <td style="text-align: right;">{{ user.last_login }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% if error %}
<div class="card" style="border-left: 5px solid #e74c3c;">
    <h2>Connection Error</h2>
    <p>Could not fetch data from Google Analytics.</p>
    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 0.9em; overflow-x: auto;">
        {{ error }}
    </div>
    <hr>
    <h3>How to Fix:</h3>
    <ol>
        <li>Go to <strong>Google Analytics Admin</strong> > <strong>Property Settings</strong> > <strong>Property Access Management</strong>.</li>
        <li>Click <strong>+</strong> then <strong>Add users</strong>.</li>
        <li>Add this Service Account email with <strong>Viewer</strong> role:</li>
    </ol>
    <div style="background: #e8f6f3; padding: 10px; border: 1px solid #27ae60; border-radius: 4px; font-weight: bold; text-align: center;">
        {{ service_email }}
    </div>
    <p style="margin-top: 10px;">Also ensure the <code>GA4_PROPERTY_ID</code> secret is set correctly in Secret Manager.</p>
</div>
{% else %}



<div class="card">
    <h2>Top Pages (Last 30 Days)</h2>
    <table class="analytics-table">
        <thead>
            <tr>
                <th>Page Title</th>
                <th>Path</th>
                <th style="text-align: right;">Views</th>
            </tr>
        </thead>
        <tbody>
            {% for page in top_pages %}
            <tr>
                <td>{{ page.title }}</td>
                <td><a href="{{ page.path }}" target="_blank">{{ page.path }}</a></td>
                <td style="text-align: right;">{{ page.views }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>


{% endif %}

<div class="card">
    <p style="text-align: center;">
        <a href="https://analytics.google.com/" target="_blank" class="button">Open Full GA4 Dashboard</a>
    </p>
</div>

<div class="card">
    <h2>Configuration Info</h2>
    <p style="font-size: 0.9em; color: #666;">If charts are unexpectedly empty, ensure this Service Account is added to your GA4 Property.</p>
    <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 0.9em; overflow-x: auto;">
        <strong>Service Account:</strong> {{ service_email }}
    </div>
</div>
{% endblock %}
