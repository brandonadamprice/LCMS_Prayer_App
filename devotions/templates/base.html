<!doctype html>
<html lang="en">
  <head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-N46CBBTKNE"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-N46CBBTKNE');
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    {% set page_title %}{% block title %}A Simple Way to Pray{% endblock %}{% endset %}
    <title>{{ page_title }}</title>

    <!-- Open Graph Meta Tags for Social Media Sharing -->
    <meta property="og:title" content="{{ page_title }}" />
    <meta property="og:description" content="A website for daily prayer, Scripture reading, and reflection on the Catechism, according to LCMS traditions." />
    <meta property="og:image" content="{{ url_for('static', filename='banner.jpg', _external=True) }}" />
    <meta property="og:url" content="{{ request.url }}" />
    <meta property="og:type" content="website" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400..700&family=Lora:ital,wght@0,400..700;1,400..700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}?v=8" />
    <link rel="icon" href="{{ url_for('static', filename='favicon.svg') }}" type="image/svg+xml" />
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#708090">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="A Simple Way to Pray">
    {% block head %}
    <link rel="preload" as="image" href="{{ url_for('static', filename='banner.jpg') }}">
    {% endblock %}
  </head>
  <body>
    <div id="art-background" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background-size: cover; background-position: center; opacity: 0; transition: opacity 2s ease; filter: sepia(0.4) blur(2px);"></div>
    <nav id="top-navbar">
      <div class="navbar-left">
        <a href="/" class="nav-brand" aria-label="Home">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
          </svg>
        </a>
      </div>

      <div class="navbar-center desktop-nav">
        {% for item in app_menu %}
          {% if item.type == 'dropdown' %}
            <div class="dropdown">
              <button class="dropbtn">{{ item.label }} â–¾</button>
              <div class="dropdown-content">
                {% for sub in item.submenu %}
                   {% if sub.enabled %}
                     {% if sub.requires_auth and not current_user.is_authenticated %}
                       {# Skip if auth required #}
                     {% else %}
                       {% if sub.separator_before %}
                         <a href="{{ sub.url }}" style="border-top: 1px solid #eee;">{{ sub.label }}</a>
                       {% else %}
                         <a href="{{ sub.url }}">{{ sub.label }}</a>
                       {% endif %}
                     {% endif %}
                   {% endif %}
                {% endfor %}
              </div>
            </div>
          {% elif item.type == 'link' %}
            <a href="{{ item.url }}" class="nav-link">{{ item.label }}</a>
          {% elif item.type == 'dynamic_favorites' %}
             {% if current_user.is_authenticated and current_user.favorites %}
              <div class="dropdown">
                <button class="dropbtn">{{ item.label }} â–¾</button>
                <div class="dropdown-content">
                  {% for fav in current_user.favorites %}
                  <a href="{{ fav.path }}">{{ fav.title }}</a>
                  {% endfor %}
                </div>
              </div>
             {% endif %}
          {% endif %}
        {% endfor %}
      </div>

      <div class="navbar-right" style="display: flex; align-items: center;">
        {% if current_user.is_authenticated %}
        <a href="/streaks" class="nav-streak scripture-tooltip" data-text="View your Prayer Journey and Achievements" style="text-decoration: none; border-bottom: none;">
            <span style="margin-right: 5px;">ðŸ”¥</span> <span id="nav-streak-count">{{ current_user.streak_count }}</span>
        </a>
        {% endif %}
        <button id="menu-button" aria-label="Menu">&#9776;</button>
        <div id="app-menu">
          <div class="app-menu-section">
            <strong>Account</strong>
            {% if current_user.is_authenticated %}
              <div class="menu-profile">
                <img src="{{ current_user.profile_pic }}" alt="{{ current_user.name }}" title="{{ current_user.name }}">
                <div class="menu-profile-info">
                  <strong>{{ current_user.name }}</strong>
                  <span>{{ current_user.email }}</span>
                </div>
              </div>
              <a href="/logout" class="button menu-button-full">Logout</a>
            {% else %}
              <a href="/login" class="button menu-button-full">Login</a>
            {% endif %}
          </div>
          <div class="app-menu-section">
            <a href="/settings" class="button menu-button-full" style="margin-bottom: 5px;">Settings</a>
            {% if current_user.is_authenticated and config['ADMIN_USER_ID'] and current_user.id == config['ADMIN_USER_ID'] %}
            <a href="/admin/traffic" class="button menu-button-full">Traffic Analytics</a>
            {% endif %}
          </div>
          <div class="app-menu-section mobile-nav">
            <strong>Navigation</strong>
            {% for item in app_menu %}
              {% if item.type == 'dropdown' %}
                <button class="menu-accordion">{{ item.label }}</button>
                <div class="menu-panel">
                  {% for sub in item.submenu %}
                     {% if sub.enabled %}
                       {% if sub.requires_auth and not current_user.is_authenticated %}
                         {# Skip #}
                       {% else %}
                         <a href="{{ sub.url }}" class="menu-sub-link">{{ sub.label }}</a>
                       {% endif %}
                     {% endif %}
                  {% endfor %}
                </div>
              {% elif item.type == 'link' %}
                 <a href="{{ item.url }}" class="menu-accordion no-arrow">{{ item.label }}</a>
              {% elif item.type == 'dynamic_favorites' %}
                  {% if current_user.is_authenticated and current_user.favorites %}
                      <button class="menu-accordion">{{ item.label }}</button>
                      <div class="menu-panel">
                          {% for fav in current_user.favorites %}
                          <a href="{{ fav.path }}" class="menu-sub-link">{{ fav.title }}</a>
                          {% endfor %}
                      </div>
                  {% endif %}
              {% endif %}
            {% endfor %}
          </div>
        </div>
      </div>
    </nav>

    <main class="container">
      {% block content %}{% endblock %}


      <footer class="footer">
        <div id="art-credit" style="text-align: center; font-size: 0.8em; margin-bottom: 10px; display: none; color: #7f8c8d;">
            Background Art: <a id="art-link" href="#" target="_blank" style="color: inherit; text-decoration: underline;"><span id="art-title"></span></a> (Full of Eyes)
        </div>
        <a href="/about">About</a> | <a href="/copyright">Copyright Information</a> | <a href="/privacy">Privacy Policy</a>
      </footer>
    </main>

    <div id="login-modal" class="modal">
      <div class="modal-content">
        <span class="close-modal" id="login-modal-close">&times;</span>
        <h2>Welcome!</h2>
        <p>Did you know? You can log in to save preferences, sync data across devices, and access features like My Prayers!</p>
        <div style="text-align: center; margin-top: 20px;">
            <a href="/login" class="button" id="modal-login-btn">Log In / Sign Up</a>
        </div>
      </div>
    </div>

    <div id="milestone-modal" class="modal">
        <div class="modal-content milestone-content">
            <span class="close-modal" onclick="closeMilestoneModal()">&times;</span>
            <div class="milestone-badge">ðŸ”¥</div>
            <h2 id="milestone-title" style="color: #27ae60; margin-top: 0;">Milestone Reached!</h2>
            <p id="milestone-message" style="font-size: 1.2em; margin: 15px 0;"></p>
            <p>Keep up the good work!</p>
            <div style="margin-top: 20px;">
                <button class="button" onclick="shareMilestone()">Share</button>
                <button class="button" onclick="closeMilestoneModal()" style="background-color: #7f8c8d;">Close</button>
            </div>
        </div>
    </div>
    {% block body_scripts %}{% endblock %}
    <script>
      // Global function to set background art
      function displayBackgroundArt(data) {
          if (localStorage.getItem('backgroundArt') === 'disabled') {
              return;
          }

          const bg = document.getElementById('art-background');
          const credit = document.getElementById('art-credit');
          const title = document.getElementById('art-title');
          const link = document.getElementById('art-link');

          if (!data || !data.image_url) return;

          const img = new Image();
          img.onload = () => {
              bg.style.backgroundImage = `url('${data.image_url}')`;
              bg.style.opacity = 0.25;
              document.body.classList.add('has-background-art');
          };
          img.src = data.image_url;

          if (title) title.textContent = data.title;
          if (link) link.href = data.link;
          if (credit) credit.style.display = 'block';
      }

      // Favorites handling
      async function toggleFavorite(path, title, callback) {
          if (!isLoggedIn) {
              alert("Please log in to favorite pages.");
              return;
          }
          
          try {
              const response = await fetch('/toggle_favorite', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ path: path, title: title }),
              });
              const data = await response.json();
              if (data.success) {
                  if (callback) callback(data.is_favorite);
              } else {
                  console.error('Toggle favorite failed:', data.error);
              }
          } catch (e) {
              console.error('Toggle favorite error:', e);
          }
      }

      // Devotion path mapping
      const PATH_TO_DEVOTION_KEY = {
          '/morning_devotion': 'morning',
          '/midday_devotion': 'midday',
          '/evening_devotion': 'evening',
          '/close_of_day_devotion': 'close_of_day',
          '/night_watch_devotion': 'night_watch',
          '/bible_in_a_year': 'bible_in_a_year',
          '/lent_devotion': 'lent'
      };

      function injectActionButtons() {
          if (!isLoggedIn) return;
          
          const pageHeader = document.querySelector('.page-header');
          if (!pageHeader) return;

          const currentPath = window.location.pathname;
          // Blocklist similar to before
          if (currentPath === '/' || currentPath === '/login' || currentPath === '/logout' || currentPath === '/settings') return;

          const devotionKey = PATH_TO_DEVOTION_KEY[currentPath];
          
          // Container for buttons
          const actionsContainer = document.createElement('div');
          actionsContainer.className = 'header-actions';
          
          // 1. Favorite Button
          let isFav = {% if current_user.is_authenticated %}{{ current_user.favorites|tojson }}{% else %}[]{% endif %}.some(f => f.path === currentPath);
          
          const favBtn = document.createElement('button');
          favBtn.className = 'action-pill btn-favorite';
          if (isFav) favBtn.classList.add('active');
          
          function updateFavUI(favState) {
              const icon = favState ? '&#9733;' : '&#9734;'; // filled vs empty star
              const text = 'Favorite';
              favBtn.innerHTML = `<span>${icon}</span> ${text}`;
              if (favState) favBtn.classList.add('active');
              else favBtn.classList.remove('active');
          }
          updateFavUI(isFav);
          
          // Get title from H1 inside header
          const headerH1 = pageHeader.querySelector('h1');
          let titleToSave = document.title;
          if (headerH1) titleToSave = headerH1.textContent.trim();

          favBtn.onclick = () => {
              toggleFavorite(currentPath, titleToSave, (newFavState) => {
                  isFav = newFavState;
                  updateFavUI(isFav);
              });
          };
          actionsContainer.appendChild(favBtn);

          // 2. Reminder Button (Only if mapped)
          if (devotionKey) {
              const remindBtn = document.createElement('button');
              remindBtn.className = 'action-pill btn-reminder';
              remindBtn.innerHTML = 'Set Reminders';
              remindBtn.onclick = () => {
                  const now = new Date();
                  let minutes = now.getMinutes();
                  
                  // Rounding logic: nearest 15
                  let roundedMinutes = Math.round(minutes / 15) * 15;
                  
                  const d = new Date(now);
                  d.setMinutes(roundedMinutes);
                  d.setSeconds(0);
                  
                  const h = String(d.getHours()).padStart(2, '0');
                  const m = String(d.getMinutes()).padStart(2, '0');
                  const timeStr = `${h}:${m}`;
                  
                  window.location.href = `/reminders?time=${timeStr}&devotion=${devotionKey}`;
              };
              actionsContainer.appendChild(remindBtn);
          }

          pageHeader.appendChild(actionsContainer);
      }

      document.addEventListener('DOMContentLoaded', injectActionButtons);

      function toggleCard(header) {
        const card = header.parentElement;
        card.classList.toggle("collapsed");
      }

      function togglePersonalPrayers(button) {
        const prayersList = document.getElementById('personal-prayers-list');
        if (prayersList) {
            prayersList.classList.toggle('hidden');
            button.textContent = prayersList.classList.contains('hidden') ? 'Show My Personal Prayers' : 'Hide My Personal Prayers';
        }
      }

      function togglePicker(button, cardIndex) {
        const picker = document.getElementById("picker-" + cardIndex);
        picker.classList.toggle("visible");
        if (picker.classList.contains("visible")) {
          button.dataset.originalText = button.innerText;
          button.innerText = "Hide List";
        } else {
          button.innerText = button.dataset.originalText || button.innerText;
        }
      }

      async function selectRef(newRef, cardIndex) {
        const picker = document.getElementById("picker-" + cardIndex);
        picker.classList.remove("visible"); // Hide picker
        const mainButton = picker.previousElementSibling; // The toggle button
        if(mainButton && mainButton.dataset.originalText) {
           mainButton.innerText = mainButton.dataset.originalText;
        }

        const currentRefEl = document.getElementById("ref-" + cardIndex);
        const textEl = document.getElementById("text-" + cardIndex);

        if (currentRefEl.innerText === newRef) {
          return; // Already showing this ref
        }

        currentRefEl.innerText = newRef;
        textEl.innerHTML = "<em>Loading...</em>";
        if(mainButton) mainButton.disabled = true;

        try {
          const response = await fetch("/get_passage_text?ref=" + encodeURIComponent(newRef));
          if (!response.ok) throw new Error("Network response was not ok");
          const data = await response.json();
          textEl.innerHTML = data.text;
        } catch (error) {
          console.error("Error fetching new ref:", error);
          textEl.innerHTML = "<em>Error loading " + newRef + ". Please try again.</em>";
        } finally {
          if(mainButton) mainButton.disabled = false;
        }
      }

      // Settings and Dark Mode
      const menuButton = document.getElementById('menu-button');
      const appMenu = document.getElementById('app-menu');
      
      const isLoggedIn = {{ current_user.is_authenticated|tojson }};
      const userDarkMode = {% if current_user.is_authenticated %}{{ current_user.dark_mode|tojson }}{% else %}null{% endif %};
      const userFontSizeLevel = {% if current_user.is_authenticated and current_user.font_size_level is not none %}{{ current_user.font_size_level }}{% else %}null{% endif %};
      const userBackgroundArt = {% if current_user.is_authenticated %}{{ current_user.background_art|tojson }}{% else %}null{% endif %};

      // Control references
      const darkModeToggleSidebar = document.getElementById('dark-mode-toggle');
      const darkModeToggleSettings = document.getElementById('settings-dark-mode-toggle');
      const backgroundArtToggleSettings = document.getElementById('settings-background-art-toggle');
      
      const decreaseFontSidebar = document.getElementById('decrease-font');
      const increaseFontSidebar = document.getElementById('increase-font');
      const resetFontSidebar = document.getElementById('reset-font');
      
      const decreaseFontSettings = document.getElementById('settings-decrease-font');
      const increaseFontSettings = document.getElementById('settings-increase-font');
      const resetFontSettings = document.getElementById('settings-reset-font');

      // Font size settings
      const FONT_SIZES = [0.8, 0.9, 1.0, 1.1, 1.2, 1.3]; // em
      let currentFontSizeIndex = 2; // Default 1.0em

      function applyFontSize(index) {
          currentFontSizeIndex = Math.max(0, Math.min(index, FONT_SIZES.length - 1));
          const sizeEm = FONT_SIZES[currentFontSizeIndex];
          document.body.style.fontSize = sizeEm + 'em';
          
          const isMin = currentFontSizeIndex === 0;
          const isMax = currentFontSizeIndex === FONT_SIZES.length - 1;

          if(decreaseFontSidebar) decreaseFontSidebar.disabled = isMin;
          if(increaseFontSidebar) increaseFontSidebar.disabled = isMax;
          if(decreaseFontSettings) decreaseFontSettings.disabled = isMin;
          if(increaseFontSettings) increaseFontSettings.disabled = isMax;
          
          const display = document.getElementById('font-size-display');
          if (display) {
              const pct = Math.round(sizeEm * 100);
              display.textContent = `(${pct}%)`;
          }
      }

      async function saveFontSizePreference(index) {
          localStorage.setItem('fontSizeLevel', index);
          if (isLoggedIn) {
              try {
                  await fetch('/save_font_size', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ font_size_level: index }),
                  });
              } catch (error) {
                  console.error('Failed to save font size preference:', error);
              }
          }
      }

      function handleIncreaseFont() {
          if(currentFontSizeIndex < FONT_SIZES.length - 1) {
              applyFontSize(currentFontSizeIndex + 1);
              saveFontSizePreference(currentFontSizeIndex);
          }
      }
      function handleDecreaseFont() {
          if(currentFontSizeIndex > 0) {
              applyFontSize(currentFontSizeIndex - 1);
              saveFontSizePreference(currentFontSizeIndex);
          }
      }
      function handleResetFont() {
          applyFontSize(2);
          saveFontSizePreference(2);
      }

      if(increaseFontSidebar) increaseFontSidebar.addEventListener('click', handleIncreaseFont);
      if(decreaseFontSidebar) decreaseFontSidebar.addEventListener('click', handleDecreaseFont);
      if(resetFontSidebar) resetFontSidebar.addEventListener('click', handleResetFont);

      if(increaseFontSettings) increaseFontSettings.addEventListener('click', handleIncreaseFont);
      if(decreaseFontSettings) decreaseFontSettings.addEventListener('click', handleDecreaseFont);
      if(resetFontSettings) resetFontSettings.addEventListener('click', handleResetFont);

      function applyDarkMode(isDark) {
        if (isDark) {
          document.body.classList.add('dark-mode');
          localStorage.setItem('darkMode', 'enabled');
        } else {
          document.body.classList.remove('dark-mode');
          localStorage.setItem('darkMode', 'disabled');
        }
        // Sync toggles
        if(darkModeToggleSidebar) darkModeToggleSidebar.checked = isDark;
        if(darkModeToggleSettings) darkModeToggleSettings.checked = isDark;
      }

      async function saveDarkModePreference(isDark) {
          localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
          if (isLoggedIn) {
              try {
                  await fetch('/save_dark_mode', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ dark_mode: isDark }),
                  });
              } catch (error) {
                  console.error('Failed to save dark mode preference:', error);
              }
          }
      }

      // Set initial dark mode state
      if (isLoggedIn && userDarkMode !== null) {
          applyDarkMode(userDarkMode);
      } else {
          applyDarkMode(localStorage.getItem('darkMode') === 'enabled');
      }

      // Set initial font size
      if (isLoggedIn && userFontSizeLevel !== null) {
          applyFontSize(userFontSizeLevel);
      } else {
          const localSize = localStorage.getItem('fontSizeLevel');
          if (localSize !== null) {
              applyFontSize(parseInt(localSize, 10));
          } else {
              applyFontSize(2); // Default
          }
      }

      // Toggle dark mode listener
      function handleDarkModeToggle(e) {
          applyDarkMode(e.target.checked);
          saveDarkModePreference(e.target.checked);
      }

      if(darkModeToggleSidebar) darkModeToggleSidebar.addEventListener('change', handleDarkModeToggle);
      if(darkModeToggleSettings) darkModeToggleSettings.addEventListener('change', handleDarkModeToggle);

      // Background Art Logic
      function setBackgroundArtPreference(enabled) {
          if (enabled) {
              localStorage.setItem('backgroundArt', 'enabled');
          } else {
              localStorage.setItem('backgroundArt', 'disabled');
              // If disabled, remove visual effects immediately
              document.body.classList.remove('has-background-art');
              const bg = document.getElementById('art-background');
              if (bg) bg.style.backgroundImage = '';
              const credit = document.getElementById('art-credit');
              if (credit) credit.style.display = 'none';
          }
          if (backgroundArtToggleSettings) backgroundArtToggleSettings.checked = enabled;
      }

      async function saveBackgroundArtPreference(enabled) {
          setBackgroundArtPreference(enabled);
          if (isLoggedIn) {
              try {
                  await fetch('/save_background_art', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ background_art: enabled }),
                  });
              } catch (error) {
                  console.error('Failed to save background art preference:', error);
              }
          }
      }

      if (backgroundArtToggleSettings) {
          backgroundArtToggleSettings.addEventListener('change', (e) => {
              saveBackgroundArtPreference(e.target.checked);
              // Reload to apply if re-enabling requires fetch, or just let user navigate
              if (e.target.checked) location.reload();
          });
      }

      // Init Background Art Preference
      if (isLoggedIn && userBackgroundArt !== null) {
          setBackgroundArtPreference(userBackgroundArt);
      } else {
          // Default to enabled if not set
          if (localStorage.getItem('backgroundArt') === null) {
             localStorage.setItem('backgroundArt', 'enabled');
          }
          setBackgroundArtPreference(localStorage.getItem('backgroundArt') === 'enabled');
      }

      // Default Background Art Loader
      async function loadDefaultArt() {
          try {
              const response = await fetch('/api/art/recent');
              const data = await response.json();
              if (data && data.image_url) {
                  displayBackgroundArt(data);
              }
          } catch (e) {
              console.error("Failed to fetch default background art", e);
          }
      }

      // Load default art if not suppressed by specific page
      document.addEventListener('DOMContentLoaded', () => {
          if (!window.suppressDefaultArt) {
              loadDefaultArt();
          }
      });

      // Toggle app menu
      menuButton.addEventListener('click', function(event) {
        appMenu.style.display = appMenu.style.display === 'block' ? 'none' : 'block';
        event.stopPropagation();
      });

      // Close menu if clicking outside
      document.addEventListener('click', function(event) {
        if (appMenu.style.display === 'block' && !appMenu.contains(event.target) && event.target !== menuButton) {
          appMenu.style.display = 'none';
        }
      });

      // Login prompt modal
      const loginModal = document.getElementById('login-modal');
      const closeLoginModal = document.getElementById('login-modal-close');
      const LOGIN_MSG_KEY = 'loginMessageShown';

      if (!isLoggedIn && !localStorage.getItem(LOGIN_MSG_KEY) && !window.location.pathname.startsWith('/login')) {
          // Show with a slight delay for better UX
          setTimeout(() => {
              if (loginModal) loginModal.classList.add('visible');
          }, 1000);
      }

      function dismissLoginModal() {
          if (loginModal) loginModal.classList.remove('visible');
          localStorage.setItem(LOGIN_MSG_KEY, 'true');
      }

      // Creed Toggle Functions
      function showApostlesCreed() {
          const ath = document.getElementById('athanasian-creed');
          const ap = document.getElementById('apostles-creed');
          if (ath && ap) {
              ath.style.display = 'none';
              ap.style.display = 'block';
          }
      }
      function showAthanasianCreed() {
          const ath = document.getElementById('athanasian-creed');
          const ap = document.getElementById('apostles-creed');
          if (ath && ap) {
              ath.style.display = 'block';
              ap.style.display = 'none';
          }
      }

      // Milestone Modal Functions
      window.triggerMilestoneModal = function(message, streak) {
          document.getElementById('milestone-message').textContent = message;
          document.getElementById('milestone-modal').classList.add('visible');
          if(navigator.vibrate) navigator.vibrate([100, 50, 100]);
          
          // Store text for sharing
          if (message.includes("Daily Office")) {
              window.milestoneShareText = "I just completed the Daily Office (Morning, Midday, Evening, and Close of Day Prayer) on A Simple Way to Pray! ðŸ“– #Christianity #Prayer";
          } else {
              window.milestoneShareText = `I just reached a ${streak} day prayer streak on A Simple Way to Pray! ðŸ”¥ #Christianity #Prayer`;
          }
      }

      function closeMilestoneModal() {
          document.getElementById('milestone-modal').classList.remove('visible');
      }

      async function shareMilestone() {
          if (navigator.share) {
              try {
                  await navigator.share({
                      title: 'Prayer Streak Milestone',
                      text: window.milestoneShareText,
                      url: window.location.origin
                  });
              } catch (err) {
                  console.log('Error sharing:', err);
              }
          } else {
              // Fallback to clipboard
              try {
                  await navigator.clipboard.writeText(window.milestoneShareText + " " + window.location.origin);
                  alert("Message copied to clipboard!");
              } catch (err) {
                  alert("Could not copy to clipboard. Please share manually.");
              }
          }
      }

      if(closeLoginModal) {
          closeLoginModal.addEventListener('click', dismissLoginModal);
      }

      const modalLoginBtn = document.getElementById('modal-login-btn');
      if (modalLoginBtn) {
          modalLoginBtn.addEventListener('click', dismissLoginModal);
      }
      
      // Close if clicking outside content
      window.addEventListener('click', function(event) {
          if (event.target == loginModal) {
              dismissLoginModal();
          }
      });
      {% block extra_js %}{% endblock %}

      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js').then(registration => {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          }, err => {
            console.log('ServiceWorker registration failed: ', err);
          });
        });
      }

      // Accordion Menu
      var acc = document.getElementsByClassName("menu-accordion");
      var i;

      for (i = 0; i < acc.length; i++) {
        acc[i].addEventListener("click", function() {
          this.classList.toggle("active");
          var panel = this.nextElementSibling;
          if (panel.style.maxHeight) {
            panel.style.maxHeight = null;
          } else {
            panel.style.maxHeight = panel.scrollHeight + "px";
            setTimeout(() => {
                if (panel.style.maxHeight) {
                    panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }, 300);
          }
        });
      }

      // Global Tooltip Toggle Logic
      document.addEventListener('click', function(event) {
          // If clicking ON a tooltip (text or pseudo-element popup)
          if (event.target.classList.contains('scripture-tooltip')) {
              const wasActive = event.target.classList.contains('active');
              
              // Close ALL tooltips first (so we don't have multiple open)
              const activeTooltips = document.querySelectorAll('.scripture-tooltip.active');
              activeTooltips.forEach(t => {
                  t.classList.remove('active');
              });

              // If it wasn't already active, open it.
              // If it WAS active, we just closed it above (toggle off behavior).
              if (!wasActive) {
                  event.target.classList.add('active');
              }
          } else {
              // Close all tooltips if clicking outside
              const activeTooltips = document.querySelectorAll('.scripture-tooltip.active');
              activeTooltips.forEach(t => {
                  t.classList.remove('active');
              });
          }
      });
    </script>
  </body>
</html>
