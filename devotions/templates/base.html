<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}Daily Devotion{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
    <link rel="icon" href="{{ url_for('static', filename='favicon.svg') }}" type="image/svg+xml" />
  </head>
  <body>
    <div id="user-status">
      {% if current_user.is_authenticated %}
          <img src="{{ current_user.profile_pic }}" alt="Profile" class="profile-pic" title="{{ current_user.name }}">
      {% else %}
          <a href="/login" class="button" style="padding: 5px 10px; font-size: 0.8em; margin: 0;">Login</a>
      {% endif %}
    </div>
    <button id="settings-button" aria-label="Settings">⚙️</button>
    <div id="settings-modal">
        <h3>Settings</h3>
        <div class="settings-item">
            <label for="dark-mode-toggle">Dark Mode</label>
            <label class="switch">
                <input type="checkbox" id="dark-mode-toggle">
                <span class="slider"></span>
            </label>
        </div>
        {% if current_user.is_authenticated %}
        <div class="settings-item" style="justify-content: center; margin-top: 20px;">
             <a href="/logout" class="button" style="padding: 8px 15px; font-size: 0.9em; margin: 0; width: 100%;">Logout</a>
        </div>
        {% endif %}
    </div>
    {% block content %}{% endblock %}
    {% if request.endpoint != 'index_route' %}
    <div style="text-align: center">
      <a href="/" class="button">Back to Home</a>
    </div>
    {% endif %}
    <script>
      function toggleCard(header) {
        const card = header.parentElement;
        card.classList.toggle("collapsed");
      }

      function togglePicker(button, cardIndex) {
        const picker = document.getElementById("picker-" + cardIndex);
        picker.classList.toggle("visible");
        if (picker.classList.contains("visible")) {
          button.dataset.originalText = button.innerText;
          button.innerText = "Hide List";
        } else {
          button.innerText = button.dataset.originalText || button.innerText;
        }
      }

      async function selectRef(newRef, cardIndex) {
        const picker = document.getElementById("picker-" + cardIndex);
        picker.classList.remove("visible"); // Hide picker
        const mainButton = picker.previousElementSibling; // The toggle button
        if(mainButton && mainButton.dataset.originalText) {
           mainButton.innerText = mainButton.dataset.originalText;
        }

        const currentRefEl = document.getElementById("ref-" + cardIndex);
        const textEl = document.getElementById("text-" + cardIndex);

        if (currentRefEl.innerText === newRef) {
          return; // Already showing this ref
        }

        currentRefEl.innerText = newRef;
        textEl.innerHTML = "<em>Loading...</em>";
        if(mainButton) mainButton.disabled = true;

        try {
          const response = await fetch("/get_passage_text?ref=" + encodeURIComponent(newRef));
          if (!response.ok) throw new Error("Network response was not ok");
          const data = await response.json();
          textEl.innerHTML = data.text;
        } catch (error) {
          console.error("Error fetching new ref:", error);
          textEl.innerHTML = "<em>Error loading " + newRef + ". Please try again.</em>";
        } finally {
          if(mainButton) mainButton.disabled = false;
        }
      }

      // Settings and Dark Mode
      const settingsButton = document.getElementById('settings-button');
      const settingsModal = document.getElementById('settings-modal');
      const darkModeToggle = document.getElementById('dark-mode-toggle');

      function applyDarkMode(isDark) {
        if (isDark) {
          document.body.classList.add('dark-mode');
          darkModeToggle.checked = true;
          localStorage.setItem('darkMode', 'enabled');
        } else {
          document.body.classList.remove('dark-mode');
          darkModeToggle.checked = false;
          localStorage.setItem('darkMode', 'disabled');
        }
      }

      // Check for saved preference on load
      const darkModePreference = localStorage.getItem('darkMode');
      if (darkModePreference === 'enabled') {
        applyDarkMode(true);
      } else {
        applyDarkMode(false);
      }

      // Toggle dark mode
      darkModeToggle.addEventListener('change', function() {
        applyDarkMode(this.checked);
      });

      // Toggle settings modal
      settingsButton.addEventListener('click', function(event) {
        settingsModal.style.display = settingsModal.style.display === 'block' ? 'none' : 'block';
        event.stopPropagation();
      });

      // Close modal if clicking outside
      document.addEventListener('click', function(event) {
        if (settingsModal.style.display === 'block' && !settingsModal.contains(event.target) && event.target !== settingsButton) {
          settingsModal.style.display = 'none';
        }
      });
      {% block extra_js %}{% endblock %}
    </script>
  </body>
</html>
