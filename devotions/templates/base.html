<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    {% set page_title %}{% block title %}A Simple Way to Pray{% endblock %}{% endset %}
    <title>{{ page_title }}</title>

    <!-- Open Graph Meta Tags for Social Media Sharing -->
    <meta property="og:title" content="{{ page_title }}" />
    <meta property="og:description" content="A website for daily prayer, Scripture reading, and reflection on the Catechism, according to LCMS traditions." />
    <meta property="og:image" content="{{ url_for('static', filename='banner.jpg', _external=True) }}" />
    <meta property="og:url" content="{{ request.url }}" />
    <meta property="og:type" content="website" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400..700&family=Lora:ital,wght@0,400..700;1,400..700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}?v=6" />
    <link rel="icon" href="{{ url_for('static', filename='favicon.svg') }}" type="image/svg+xml" />
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#708090">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="A Simple Way to Pray">
  </head>
  <body>
    <nav id="top-navbar">
      <div class="navbar-left">
        <a href="/" class="nav-brand" aria-label="Home">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
          </svg>
        </a>
      </div>

      <div class="navbar-center desktop-nav" {% if request.endpoint == 'index_route' %}style="visibility: hidden;"{% endif %}>
        <div class="dropdown">
          <button class="dropbtn">Daily Prayer ▾</button>
          <div class="dropdown-content">
            <a href="/morning_devotion">Morning</a>
            <a href="/midday_devotion">Midday</a>
            <a href="/evening_devotion">Evening</a>
            <a href="/close_of_day_devotion">Close of Day</a>
            <a href="/night_watch_devotion">Night Watch</a>
          </div>
        </div>
        <div class="dropdown">
          <button class="dropbtn">Devotions ▾</button>
          <div class="dropdown-content">
            {% if is_advent %}
            <a href="/advent_devotion">Advent</a>
            {% endif %}
            {% if is_new_year %}
            <a href="/new_year_devotion">New Year's</a>
            {% endif %}
            <a href="/childrens_devotion">Children's</a>
            <a href="/litany">The Litany</a>
            <a href="/extended_evening_devotion">Extended Evening</a>
            <a href="/mid_week_devotion">Mid-Week</a>
            <a href="/short_prayers">Short Prayers</a>
          </div>
        </div>
        <div class="dropdown">
          <button class="dropbtn">Bible ▾</button>
          <div class="dropdown-content">
            <a href="/daily_lectionary">Daily Lectionary</a>
            <a href="/psalms_by_category">Psalms</a>
            <a href="/gospels_by_category">Gospels</a>
            <a href="/bible_in_a_year">Bible in a Year</a>
            <a href="/memory">Memorization</a>
          </div>
        </div>
        <div class="dropdown">
          <button class="dropbtn">Prayer ▾</button>
          <div class="dropdown-content">
            <a href="/prayer_requests">Submit Request</a>
            <a href="/prayer_wall">Prayer Wall</a>
            {% if current_user.is_authenticated %}
            <a href="/my_prayers">My Prayers</a>
            {% endif %}
          </div>
        </div>
        <a href="/liturgical_calendar" class="nav-link">Calendar</a>
        {% if current_user.is_authenticated and current_user.favorites %}
        <div class="dropdown">
          <button class="dropbtn">Favorites ▾</button>
          <div class="dropdown-content">
            {% for fav in current_user.favorites %}
            <a href="{{ fav.path }}">{{ fav.title }}</a>
            {% endfor %}
          </div>
        </div>
        {% endif %}
        <a href="/feedback" class="nav-link">Feedback</a>
      </div>

      <div class="navbar-right">
        <button id="menu-button" aria-label="Menu">&#9776;</button>
        <div id="app-menu">
          <div class="app-menu-section">
            <strong>Account</strong>
            {% if current_user.is_authenticated %}
              <div class="menu-profile">
                <img src="{{ current_user.profile_pic }}" alt="{{ current_user.name }}" title="{{ current_user.name }}">
                <div class="menu-profile-info">
                  <strong>{{ current_user.name }}</strong>
                  <span>{{ current_user.email }}</span>
                </div>
              </div>
              <a href="/account" class="button menu-button-full" style="background-color: #2980b9; margin-bottom: 5px;">Account Settings</a>
              <a href="/logout" class="button menu-button-full">Logout</a>
            {% else %}
              <a href="/login" class="button menu-button-full">Login</a>
            {% endif %}
          </div>
          <div class="app-menu-section mobile-nav">
            <strong>Navigation</strong>
            <a href="/" class="button menu-button-full">Home</a>
            
            <button class="menu-accordion">Daily Prayer</button>
            <div class="menu-panel">
              <a href="/morning_devotion" class="menu-sub-link">Morning</a>
              <a href="/midday_devotion" class="menu-sub-link">Midday</a>
              <a href="/evening_devotion" class="menu-sub-link">Evening</a>
              <a href="/close_of_day_devotion" class="menu-sub-link">Close of Day</a>
              <a href="/night_watch_devotion" class="menu-sub-link">Night Watch</a>
            </div>

            <button class="menu-accordion">Seasonal Devotions</button>
            <div class="menu-panel">
               {% if is_advent %}
               <a href="/advent_devotion" class="menu-sub-link">Advent Family Devotional</a>
               {% else %}
               <span class="menu-sub-link disabled">Advent (Seasonal)</span>
               {% endif %}
               {% if is_new_year %}
               <a href="/new_year_devotion" class="menu-sub-link">New Year's Devotion</a>
               {% else %}
               <span class="menu-sub-link disabled">New Year's (Seasonal)</span>
               {% endif %}
            </div>

            <button class="menu-accordion">Children's Devotions</button>
            <div class="menu-panel">
                <a href="/childrens_devotion" class="menu-sub-link">Children's Daily Devotion</a>
            </div>

            <button class="menu-accordion">Other Devotions</button>
            <div class="menu-panel">
                <a href="/litany" class="menu-sub-link">The Litany</a>
                <a href="/extended_evening_devotion" class="menu-sub-link">Extended Evening</a>
                <a href="/mid_week_devotion" class="menu-sub-link">Mid-Week Devotion</a>
                <a href="/short_prayers" class="menu-sub-link">Short Prayers</a>
            </div>

            <button class="menu-accordion">Calendar</button>
            <div class="menu-panel">
                <a href="/liturgical_calendar" class="menu-sub-link">Liturgical Calendar</a>
            </div>

            <button class="menu-accordion">Bible Helps</button>
            <div class="menu-panel">
                <a href="/daily_lectionary" class="menu-sub-link">Daily Lectionary</a>
                <a href="/psalms_by_category" class="menu-sub-link">Psalms</a>
                <a href="/gospels_by_category" class="menu-sub-link">Gospels</a>
                <a href="/bible_in_a_year" class="menu-sub-link">Bible in a Year</a>
                <a href="/memory" class="menu-sub-link">Scripture Memorization</a>
            </div>

            <button class="menu-accordion">Prayer Requests</button>
            <div class="menu-panel">
                <a href="/prayer_requests" class="menu-sub-link">Submit a Request</a>
                <a href="/prayer_wall" class="menu-sub-link">Pray for Someone</a>
                {% if current_user.is_authenticated %}
                <a href="/my_prayers" class="menu-sub-link">My Personal Prayers</a>
                {% endif %}
            </div>

            {% if current_user.is_authenticated and current_user.favorites %}
            <button class="menu-accordion">Favorites</button>
            <div class="menu-panel">
                {% for fav in current_user.favorites %}
                <a href="{{ fav.path }}" class="menu-sub-link">{{ fav.title }}</a>
                {% endfor %}
            </div>
            {% endif %}

            <button class="menu-accordion">Feedback</button>
            <div class="menu-panel">
                <a href="/feedback" class="menu-sub-link">Submit Feedback</a>
            </div>
          </div>
          <div class="app-menu-section">
            <strong>Settings</strong>
            {% if current_user.is_authenticated %}
            <a href="/reminders" class="button menu-button-full">Prayer Reminders</a>
            {% endif %}
            <div class="menu-item">
                <label for="dark-mode-toggle">Dark Mode</label>
                <label class="switch">
                    <input type="checkbox" id="dark-mode-toggle">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="menu-item">
              <span>Font Size</span>
              <div class="font-controls">
                  <button id="decrease-font" aria-label="Decrease font size">-</button>
                  <button id="reset-font" aria-label="Reset font size">1x</button>
                  <button id="increase-font" aria-label="Increase font size">+</button>
              </div>
          </div>
          {% if current_user.is_authenticated and config['ADMIN_USER_ID'] and current_user.id == config['ADMIN_USER_ID'] %}
          <a href="/admin/traffic" class="button menu-button-full">Traffic Analytics</a>
          {% endif %}
          </div>
        </div>
      </div>
    </nav>

    <main class="container">
      {% block content %}{% endblock %}


      <footer class="footer">
        <a href="/about">About</a> | <a href="/copyright">Copyright Information</a> | <a href="/privacy">Privacy Policy</a>
      </footer>
    </main>

    <div id="login-modal" class="modal">
      <div class="modal-content">
        <span class="close-modal" id="login-modal-close">&times;</span>
        <h2>Welcome!</h2>
        <p>Did you know? You can log in to save preferences, sync data across devices, and access features like My Prayers!</p>
        <div style="text-align: center; margin-top: 20px;">
            <a href="/login" class="button" id="modal-login-btn">Log In / Sign Up</a>
        </div>
      </div>
    </div>
    {% block body_scripts %}{% endblock %}
    <script>
      // Favorites handling
      async function toggleFavorite(path, title) {
          if (!isLoggedIn) {
              alert("Please log in to favorite pages.");
              return;
          }
          const icon = document.getElementById('favorite-icon');
          if (!icon) return;
          
          try {
              const response = await fetch('/toggle_favorite', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ path: path, title: title }),
              });
              const data = await response.json();
              if (data.success) {
                  if (data.is_favorite) {
                      icon.classList.add('active');
                      icon.innerHTML = '★'; // Solid star
                  } else {
                      icon.classList.remove('active');
                      icon.innerHTML = '☆'; // Outline star
                  }
                  // Optionally reload to update menu/home, but that disrupts user.
                  // Just UI update is fine.
              } else {
                  console.error('Toggle favorite failed:', data.error);
              }
          } catch (e) {
              console.error('Toggle favorite error:', e);
          }
      }

      function injectFavoriteButton() {
          if (!isLoggedIn) return;
          
          const headerH1 = document.querySelector('.page-header h1');
          if (headerH1) {
              const currentPath = window.location.pathname;
              // Ignore home, feedback, etc if desired, but user said 'devotions'. 
              // We can just enable for all non-root pages for simplicity or allow user to favorite anything.
              if (currentPath === '/' || currentPath === '/login' || currentPath === '/logout') return;

              const isFav = {% if current_user.is_authenticated %}{{ current_user.favorites|tojson }}{% else %}[]{% endif %}.some(f => f.path === currentPath);
              
              const starSpan = document.createElement('span');
              starSpan.id = 'favorite-icon';
              starSpan.style.cursor = 'pointer';
              starSpan.style.marginLeft = '10px';
              starSpan.style.color = '#f1c40f';
              starSpan.style.fontSize = '0.8em'; // relative to H1
              starSpan.title = 'Toggle Favorite';
              starSpan.innerHTML = isFav ? '★' : '☆';
              if (isFav) starSpan.classList.add('active');
              
              // Use page title, strip newlines/extra spaces
              let pageTitle = document.title.replace("Prayer & Scripture Companion", "").trim();
              if (!pageTitle) pageTitle = headerH1.textContent; 
              // Sometimes document.title has the app name appended or prepended.
              // Let's use h1 text as default title if reasonable.
              const titleToSave = headerH1.textContent.trim();

              starSpan.onclick = () => toggleFavorite(currentPath, titleToSave);
              headerH1.appendChild(starSpan);
          }
      }

      document.addEventListener('DOMContentLoaded', injectFavoriteButton);

      function toggleCard(header) {
        const card = header.parentElement;
        card.classList.toggle("collapsed");
      }

      function togglePersonalPrayers(button) {
        const prayersList = document.getElementById('personal-prayers-list');
        if (prayersList) {
            prayersList.classList.toggle('hidden');
            button.textContent = prayersList.classList.contains('hidden') ? 'Show My Personal Prayers' : 'Hide My Personal Prayers';
        }
      }

      function togglePicker(button, cardIndex) {
        const picker = document.getElementById("picker-" + cardIndex);
        picker.classList.toggle("visible");
        if (picker.classList.contains("visible")) {
          button.dataset.originalText = button.innerText;
          button.innerText = "Hide List";
        } else {
          button.innerText = button.dataset.originalText || button.innerText;
        }
      }

      async function selectRef(newRef, cardIndex) {
        const picker = document.getElementById("picker-" + cardIndex);
        picker.classList.remove("visible"); // Hide picker
        const mainButton = picker.previousElementSibling; // The toggle button
        if(mainButton && mainButton.dataset.originalText) {
           mainButton.innerText = mainButton.dataset.originalText;
        }

        const currentRefEl = document.getElementById("ref-" + cardIndex);
        const textEl = document.getElementById("text-" + cardIndex);

        if (currentRefEl.innerText === newRef) {
          return; // Already showing this ref
        }

        currentRefEl.innerText = newRef;
        textEl.innerHTML = "<em>Loading...</em>";
        if(mainButton) mainButton.disabled = true;

        try {
          const response = await fetch("/get_passage_text?ref=" + encodeURIComponent(newRef));
          if (!response.ok) throw new Error("Network response was not ok");
          const data = await response.json();
          textEl.innerHTML = data.text;
        } catch (error) {
          console.error("Error fetching new ref:", error);
          textEl.innerHTML = "<em>Error loading " + newRef + ". Please try again.</em>";
        } finally {
          if(mainButton) mainButton.disabled = false;
        }
      }

      // Settings and Dark Mode
      const menuButton = document.getElementById('menu-button');
      const appMenu = document.getElementById('app-menu');
      const darkModeToggle = document.getElementById('dark-mode-toggle');
      const isLoggedIn = {{ current_user.is_authenticated|tojson }};
      const userDarkMode = {% if current_user.is_authenticated %}{{ current_user.dark_mode|tojson }}{% else %}null{% endif %};
      const userFontSizeLevel = {% if current_user.is_authenticated and current_user.font_size_level is not none %}{{ current_user.font_size_level }}{% else %}null{% endif %};

      // Font size settings
      const FONT_SIZES = [0.8, 0.9, 1.0, 1.1, 1.2, 1.3]; // em
      let currentFontSizeIndex = 2; // Default 1.0em

      function applyFontSize(index) {
          currentFontSizeIndex = Math.max(0, Math.min(index, FONT_SIZES.length - 1));
          document.body.style.fontSize = FONT_SIZES[currentFontSizeIndex] + 'em';
          document.getElementById('decrease-font').disabled = currentFontSizeIndex === 0;
          document.getElementById('increase-font').disabled = currentFontSizeIndex === FONT_SIZES.length - 1;
      }

      async function saveFontSizePreference(index) {
          localStorage.setItem('fontSizeLevel', index);
          if (isLoggedIn) {
              try {
                  await fetch('/save_font_size', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ font_size_level: index }),
                  });
              } catch (error) {
                  console.error('Failed to save font size preference:', error);
              }
          }
      }

      document.getElementById('increase-font').addEventListener('click', () => {
          if(currentFontSizeIndex < FONT_SIZES.length - 1) {
              applyFontSize(currentFontSizeIndex + 1);
              saveFontSizePreference(currentFontSizeIndex);
          }
      });
      document.getElementById('decrease-font').addEventListener('click', () => {
          if(currentFontSizeIndex > 0) {
              applyFontSize(currentFontSizeIndex - 1);
              saveFontSizePreference(currentFontSizeIndex);
          }
      });
      document.getElementById('reset-font').addEventListener('click', () => {
          applyFontSize(2);
          saveFontSizePreference(2);
      });

      function applyDarkMode(isDark) {
        if (isDark) {
          document.body.classList.add('dark-mode');
          darkModeToggle.checked = true;
          localStorage.setItem('darkMode', 'enabled');
        } else {
          document.body.classList.remove('dark-mode');
          darkModeToggle.checked = false;
          localStorage.setItem('darkMode', 'disabled');
        }
      }

      async function saveDarkModePreference(isDark) {
          localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
          if (isLoggedIn) {
              try {
                  await fetch('/save_dark_mode', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ dark_mode: isDark }),
                  });
              } catch (error) {
                  console.error('Failed to save dark mode preference:', error);
              }
          }
      }

      // Set initial dark mode state
      if (isLoggedIn && userDarkMode !== null) {
          applyDarkMode(userDarkMode);
      } else {
          applyDarkMode(localStorage.getItem('darkMode') === 'enabled');
      }

      // Set initial font size
      if (isLoggedIn && userFontSizeLevel !== null) {
          applyFontSize(userFontSizeLevel);
      } else {
          const localSize = localStorage.getItem('fontSizeLevel');
          if (localSize !== null) {
              applyFontSize(parseInt(localSize, 10));
          } else {
              applyFontSize(2); // Default
          }
      }

      // Toggle dark mode
      darkModeToggle.addEventListener('change', function() {
        applyDarkMode(this.checked);
        saveDarkModePreference(this.checked);
      });

      // Toggle app menu
      menuButton.addEventListener('click', function(event) {
        appMenu.style.display = appMenu.style.display === 'block' ? 'none' : 'block';
        event.stopPropagation();
      });

      // Close menu if clicking outside
      document.addEventListener('click', function(event) {
        if (appMenu.style.display === 'block' && !appMenu.contains(event.target) && event.target !== menuButton) {
          appMenu.style.display = 'none';
        }
      });

      // Login prompt modal
      const loginModal = document.getElementById('login-modal');
      const closeLoginModal = document.getElementById('login-modal-close');
      const LOGIN_MSG_KEY = 'loginMessageShown';

      if (!isLoggedIn && !localStorage.getItem(LOGIN_MSG_KEY) && !window.location.pathname.startsWith('/login')) {
          // Show with a slight delay for better UX
          setTimeout(() => {
              if (loginModal) loginModal.classList.add('visible');
          }, 1000);
      }

      function dismissLoginModal() {
          if (loginModal) loginModal.classList.remove('visible');
          localStorage.setItem(LOGIN_MSG_KEY, 'true');
      }

      if(closeLoginModal) {
          closeLoginModal.addEventListener('click', dismissLoginModal);
      }

      const modalLoginBtn = document.getElementById('modal-login-btn');
      if (modalLoginBtn) {
          modalLoginBtn.addEventListener('click', dismissLoginModal);
      }
      
      // Close if clicking outside content
      window.addEventListener('click', function(event) {
          if (event.target == loginModal) {
              dismissLoginModal();
          }
      });
      {% block extra_js %}{% endblock %}

      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js').then(registration => {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          }, err => {
            console.log('ServiceWorker registration failed: ', err);
          });
        });
      }

      // Accordion Menu
      var acc = document.getElementsByClassName("menu-accordion");
      var i;

      for (i = 0; i < acc.length; i++) {
        acc[i].addEventListener("click", function() {
          this.classList.toggle("active");
          var panel = this.nextElementSibling;
          if (panel.style.maxHeight) {
            panel.style.maxHeight = null;
          } else {
            panel.style.maxHeight = panel.scrollHeight + "px";
          }
        });
      }
    </script>
  </body>
</html>
