<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}Daily Devotion{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
    <link rel="icon" href="{{ url_for('static', filename='favicon.svg') }}" type="image/svg+xml" />
  </head>
  <body>
    <button id="menu-button" aria-label="Menu">&#9776;</button>
    <div id="app-menu">
      <div class="app-menu-section">
        <strong>Account</strong>
        {% if current_user.is_authenticated %}
          <div class="menu-profile">
            <img src="{{ current_user.profile_pic }}" alt="{{ current_user.name }}" title="{{ current_user.name }}">
            <div class="menu-profile-info">
              <strong>{{ current_user.name }}</strong>
              <span>{{ current_user.email }}</span>
            </div>
          </div>
          <a href="/logout" class="button menu-button-full">Logout</a>
        {% else %}
          <a href="/login" class="button menu-button-full">Login</a>
        {% endif %}
      </div>
      <div class="app-menu-section">
        <strong>Settings</strong>
        <div class="menu-item">
            <label for="dark-mode-toggle">Dark Mode</label>
            <label class="switch">
                <input type="checkbox" id="dark-mode-toggle">
                <span class="slider"></span>
            </label>
        </div>
      </div>
    </div>
    {% block content %}{% endblock %}
    {% if request.endpoint != 'index_route' %}
    <div style="text-align: center">
      <a href="/" class="button">Back to Home</a>
    </div>
    {% endif %}
    <footer class="footer">
      <a href="/copyright">Copyright Information</a>
    </footer>
    <script>
      function toggleCard(header) {
        const card = header.parentElement;
        card.classList.toggle("collapsed");
      }

      function togglePicker(button, cardIndex) {
        const picker = document.getElementById("picker-" + cardIndex);
        picker.classList.toggle("visible");
        if (picker.classList.contains("visible")) {
          button.dataset.originalText = button.innerText;
          button.innerText = "Hide List";
        } else {
          button.innerText = button.dataset.originalText || button.innerText;
        }
      }

      async function selectRef(newRef, cardIndex) {
        const picker = document.getElementById("picker-" + cardIndex);
        picker.classList.remove("visible"); // Hide picker
        const mainButton = picker.previousElementSibling; // The toggle button
        if(mainButton && mainButton.dataset.originalText) {
           mainButton.innerText = mainButton.dataset.originalText;
        }

        const currentRefEl = document.getElementById("ref-" + cardIndex);
        const textEl = document.getElementById("text-" + cardIndex);

        if (currentRefEl.innerText === newRef) {
          return; // Already showing this ref
        }

        currentRefEl.innerText = newRef;
        textEl.innerHTML = "<em>Loading...</em>";
        if(mainButton) mainButton.disabled = true;

        try {
          const response = await fetch("/get_passage_text?ref=" + encodeURIComponent(newRef));
          if (!response.ok) throw new Error("Network response was not ok");
          const data = await response.json();
          textEl.innerHTML = data.text;
        } catch (error) {
          console.error("Error fetching new ref:", error);
          textEl.innerHTML = "<em>Error loading " + newRef + ". Please try again.</em>";
        } finally {
          if(mainButton) mainButton.disabled = false;
        }
      }

      // Settings and Dark Mode
      const menuButton = document.getElementById('menu-button');
      const appMenu = document.getElementById('app-menu');
      const darkModeToggle = document.getElementById('dark-mode-toggle');
      const isLoggedIn = {{ current_user.is_authenticated|tojson }};
      const userDarkMode = {% if current_user.is_authenticated %}{{ current_user.dark_mode|tojson }}{% else %}null{% endif %};

      function applyDarkMode(isDark) {
        if (isDark) {
          document.body.classList.add('dark-mode');
          darkModeToggle.checked = true;
          localStorage.setItem('darkMode', 'enabled');
        } else {
          document.body.classList.remove('dark-mode');
          darkModeToggle.checked = false;
          localStorage.setItem('darkMode', 'disabled');
        }
      }

      async function saveDarkModePreference(isDark) {
          localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
          if (isLoggedIn) {
              try {
                  await fetch('/save_dark_mode', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ dark_mode: isDark }),
                  });
              } catch (error) {
                  console.error('Failed to save dark mode preference:', error);
              }
          }
      }

      // Set initial dark mode state
      if (isLoggedIn && userDarkMode !== null) {
          applyDarkMode(userDarkMode);
      } else {
          applyDarkMode(localStorage.getItem('darkMode') === 'enabled');
      }

      // Toggle dark mode
      darkModeToggle.addEventListener('change', function() {
        applyDarkMode(this.checked);
        saveDarkModePreference(this.checked);
      });

      // Toggle app menu
      menuButton.addEventListener('click', function(event) {
        appMenu.style.display = appMenu.style.display === 'block' ? 'none' : 'block';
        event.stopPropagation();
      });

      // Close menu if clicking outside
      document.addEventListener('click', function(event) {
        if (appMenu.style.display === 'block' && !appMenu.contains(event.target) && event.target !== menuButton) {
          appMenu.style.display = 'none';
        }
      });
      {% block extra_js %}{% endblock %}
    </script>
  </body>
</html>
