{% extends "base.html" %}
{% import "_macros.html" as macros with context %}

{% block title %}Small Catechism{% endblock %}

{% block content %}
<div class="page-header">
  <h1>Luther's Small Catechism</h1>
  <p>A simple explanation of Christian doctrine for the household.</p>
</div>

<!-- Navigation Menu -->
<div class="card">
    <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
        <label for="catechism-nav" style="font-weight: bold; color: #555; margin-bottom: 0;">Select Part:</label>
        
        <div style="display: flex; align-items: center;">
            <label class="switch">
                <input type="checkbox" id="learning-mode-toggle">
                <span class="slider"></span>
            </label>
            <span style="margin-left: 10px; font-size: 0.9em; font-weight: bold; color: #2980b9;">
                <span class="scripture-tooltip" data-text="Enable to view in-depth explanations from the Large Catechism and take interactive quizzes." style="border-bottom: none; font-size: 1.2em; vertical-align: middle; margin-right: 3px;">&#9432;</span>
                Learning Mode
            </span>
        </div>
    </div>

    <div style="display: flex; gap: 10px; align-items: center; justify-content: space-between; flex-wrap: nowrap;">
        <button class="button" onclick="navigate(-1)" style="margin: 0; padding: 10px 15px; flex-shrink: 0;" aria-label="Previous Part">&laquo;</button>
        <div style="flex-grow: 1; min-width: 0;">
            <select id="catechism-nav" onchange="showPart(this.value)" class="form-input" style="width: 100%; text-overflow: ellipsis;">
                {% for group_name, sections in grouped_catechism.items() %}
                    <option value="{{ loop.index0 }}">{{ group_name }}</option>
                {% endfor %}
            </select>
        </div>
        <button class="button" onclick="navigate(1)" style="margin: 0; padding: 10px 15px;" aria-label="Next Part">&raquo;</button>
    </div>
</div>

<div id="catechism-container">
{% for group_name, sections in grouped_catechism.items() %}
    <div id="part-{{ loop.index0 }}" class="catechism-part" style="display: {% if loop.first %}block{% else %}none{% endif %};">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #2980b9; padding-bottom: 10px;">
             <h2 style="margin: 0; border: none; color: #2980b9;">{{ group_name }}</h2>
        </div>
        
        <div style="margin-bottom: 15px; text-align: right;">
             <button class="button" onclick="expandAllInPart('part-{{ loop.index0 }}')" style="font-size: 0.8em; padding: 5px 10px;">Expand All</button>
             <button class="button" onclick="collapseAllInPart('part-{{ loop.index0 }}')" style="font-size: 0.8em; padding: 5px 10px;">Collapse All</button>
        </div>

        {% if group_name == "Christian Questions with Their Answers" %}
            {% for section in sections %}
                {% if section.text %}
                    <div class="card">
                        <div class="card-content">
                            <div style="font-size: 1.1em;">{{ section.text|safe }}</div>
                        </div>
                    </div>
                {% endif %}

                {# Render Section Explanation if available #}
                {% if section.explanation %}
                   <div class="card learning-content hidden">
                        <p class="subheader"><strong>Introduction</strong></p>
                        <div class="learning-explanation">
                            {{ section.explanation|safe }}
                        </div>
                   </div>
                {% endif %}

                {% for qa in section.questions_and_answers %}
                    {% call macros.card(qa.question, collapsed=True) %}
                        <p>{{ qa.answer|safe }}</p>

                        {% if qa.explanation %}
                        <div class="learning-content hidden">
                            <p class="subheader"><strong>Explanation</strong></p>
                            <div class="learning-explanation">
                                {{ qa.explanation|safe }}
                            </div>

                            {% if qa.quiz_questions %}
                            <p class="subheader"><strong>Quiz</strong></p>
                            {% for q in qa.quiz_questions %}
                            <div class="quiz-container">
                                <p style="font-weight: bold; margin-bottom: 10px;">{{ q.question|safe }}</p>
                                <div class="quiz-options">
                                    {% for option in q.options %}
                                    <button class="quiz-option" onclick="checkQuizAnswer(this, '{{ q.answer|replace("'", "\\'") }}')">{{ option|safe }}</button>
                                    {% endfor %}
                                </div>
                                <p class="quiz-feedback"></p>
                            </div>
                            {% endfor %}
                            {% endif %}
                        </div>
                        {% endif %}
                    {% endcall %}
                {% endfor %}
            {% endfor %}
        {% else %}
            {% for section in sections %}
                {% call macros.card(section.title, collapsed=True) %}
                    {% if section.text %}
                        <div style="margin-bottom: 15px; font-size: 1.1em;">{{ section.text|safe }}</div>
                    {% endif %}

                    {% for qa in section.questions_and_answers %}
                        <div class="catechism-qa">
                            <p><strong>{{ qa.question }}</strong></p>
                            <p>{{ qa.answer|safe }}</p>
                        </div>
                    {% endfor %}

                    {% if section.explanation %}
                    <div class="learning-content hidden">
                        <p class="subheader"><strong>Explanation (Large Catechism Summary)</strong></p>
                        <div class="learning-explanation">
                            {{ section.explanation|safe }}
                        </div>

                        {% if section.quiz_questions %}
                        <p class="subheader"><strong>Quiz</strong></p>
                        {% for q in section.quiz_questions %}
                        <div class="quiz-container">
                            <p style="font-weight: bold; margin-bottom: 10px;">{{ q.question|safe }}</p>
                            <div class="quiz-options">
                                {% for option in q.options %}
                                <button class="quiz-option" onclick="checkQuizAnswer(this, '{{ q.answer|replace("'", "\\'") }}')">{{ option|safe }}</button>
                                {% endfor %}
                            </div>
                            <p class="quiz-feedback"></p>
                        </div>
                        {% endfor %}
                        {% endif %}
                    </div>
                    {% endif %}
                {% endcall %}
            {% endfor %}
        {% endif %}

        <div style="display: flex; justify-content: space-between; margin-top: 30px;">
             <button class="button" onclick="navigate(-1)" {% if loop.first %}disabled style="opacity: 0.5;"{% endif %}>&laquo; Previous Part</button>
             <button class="button" onclick="navigate(1)" {% if loop.last %}disabled style="opacity: 0.5;"{% endif %}>Next Part &raquo;</button>
        </div>
    </div>
{% endfor %}
</div>

<p style="text-align: center; margin-top: 30px; font-style: italic; color: #7f8c8d; font-size: 0.9em;">
    Catechism text sourced from <a href="https://bookofconcord.org/small-catechism/" target="_blank" style="color: inherit; text-decoration: underline;">bookofconcord.org</a>.
</p>

{% endblock %}

{% block extra_js %}
let indexToSlug = {};
let slugToIndex = {};

function initSlugs() {
    const select = document.getElementById('catechism-nav');
    for (let i = 0; i < select.options.length; i++) {
        const opt = select.options[i];
        const name = opt.text;
        const slug = name.toLowerCase()
            .replace(/'/g, '')
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-+|-+$/g, '');
        
        const index = opt.value; 
        indexToSlug[index] = slug;
        slugToIndex[slug] = index;
    }
}

function showPart(index, updateHistory = true) {
    const parts = document.querySelectorAll('.catechism-part');
    parts.forEach(el => el.style.display = 'none');
    
    const selected = document.getElementById('part-' + index);
    if(selected) {
        selected.style.display = 'block';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    const select = document.getElementById('catechism-nav');
    select.value = index;

    if (updateHistory && indexToSlug[index]) {
        const slug = indexToSlug[index];
        if (window.location.hash !== '#' + slug) {
            window.location.hash = slug;
        }
    }
}

function navigate(delta) {
    const select = document.getElementById('catechism-nav');
    let currentIndex = parseInt(select.value);
    let newIndex = currentIndex + delta;
    
    const maxIndex = select.options.length - 1;
    if(newIndex < 0) newIndex = 0;
    if(newIndex > maxIndex) newIndex = maxIndex;
    
    if(newIndex !== currentIndex) {
        showPart(newIndex);
    }
}

function expandAllInPart(partId) {
    document.querySelectorAll('#' + partId + ' .card').forEach(card => {
        card.classList.remove('collapsed');
    });
}

function collapseAllInPart(partId) {
    document.querySelectorAll('#' + partId + ' .card').forEach(card => {
        card.classList.add('collapsed');
    });
}

// Learning Mode Logic
const learningToggle = document.getElementById('learning-mode-toggle');

function toggleLearningMode(enabled) {
    const content = document.querySelectorAll('.learning-content');
    content.forEach(el => {
        if (enabled) {
            el.classList.remove('hidden');
        } else {
            el.classList.add('hidden');
        }
    });
    localStorage.setItem('catechismLearningMode', enabled);
}

learningToggle.addEventListener('change', (e) => {
    toggleLearningMode(e.target.checked);
});

// Quiz Logic
function checkQuizAnswer(btn, correctAnswer) {
    const container = btn.closest('.quiz-container');
    const feedback = container.querySelector('.quiz-feedback');
    const allBtns = container.querySelectorAll('.quiz-option');
    
    // Disable all buttons in this question
    allBtns.forEach(b => b.disabled = true);
    
    if (btn.innerText === correctAnswer) {
        btn.classList.add('correct');
        feedback.innerText = "Correct! âœ…";
        feedback.classList.add('success');
        feedback.classList.remove('error');
    } else {
        btn.classList.add('incorrect');
        
        // Highlight correct answer
        allBtns.forEach(b => {
            if (b.innerText === correctAnswer) {
                b.classList.add('correct');
            }
        });
        
        feedback.innerText = "Incorrect. The correct answer is highlighted.";
        feedback.classList.add('error');
        feedback.classList.remove('success');
    }
    feedback.style.display = 'block';
}

// Tooltip Toggle Logic
document.addEventListener('click', function(event) {
    if (event.target.classList.contains('scripture-tooltip')) {
        // Toggle active class on the clicked tooltip
        event.target.classList.toggle('active');
        
        // Optional: Close other open tooltips to keep it clean?
        // User asked to dismiss by clicking *it* again, implying others might stay open or it's independent.
        // Standard tooltip behavior usually allows only one, but let's stick to simple toggle for now.
        // If we want to close others:
        /*
        const others = document.querySelectorAll('.scripture-tooltip.active');
        others.forEach(t => {
            if (t !== event.target) {
                t.classList.remove('active');
            }
        });
        */
    } else {
        // Close all tooltips if clicking outside
        const activeTooltips = document.querySelectorAll('.scripture-tooltip.active');
        activeTooltips.forEach(t => {
            t.classList.remove('active');
        });
    }
});

document.addEventListener('DOMContentLoaded', () => {
    initSlugs();
    
    // Check initial hash
    const hash = window.location.hash.substring(1);
    if (hash && slugToIndex.hasOwnProperty(hash)) {
        showPart(slugToIndex[hash], false); 
    }

    // Init Learning Mode
    const savedMode = localStorage.getItem('catechismLearningMode') === 'true';
    learningToggle.checked = savedMode;
    toggleLearningMode(savedMode);
});

window.addEventListener('hashchange', () => {
    const hash = window.location.hash.substring(1);
    let index = 0; // Default to first part if hash is empty/invalid
    if (hash && slugToIndex.hasOwnProperty(hash)) {
        index = slugToIndex[hash];
    }
    
    const select = document.getElementById('catechism-nav');
    // Only update if we aren't already showing this part
    if (select.value != index) {
        showPart(index, false);
    }
});
{% endblock %}
