{% extends "base.html" %}
{% block title %}Settings{% endblock %}
{% block content %}
<div class="page-header">
  <h1>Settings</h1>
  <p>Customize your experience.</p>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="card">
      {% for category, message in messages %}
        <div class="alert alert-{{ category }}" style="color: {% if category == 'error' %}red{% else %}green{% endif %}; margin-bottom: 10px;">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<div class="card">
  <h2>Appearance</h2>
  
  <div style="margin-bottom: 20px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <label for="settings-dark-mode-toggle" style="font-size: 1.1em; font-weight: bold;">Dark Mode</label>
        <label class="switch">
            <input type="checkbox" id="settings-dark-mode-toggle">
            <span class="slider"></span>
        </label>
      </div>
      <p style="color: #7f8c8d; font-size: 0.9em; margin-top: 0;">Switch between light and dark themes.</p>
  </div>

  <hr>

  <div style="margin-top: 20px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <span style="font-size: 1.1em; font-weight: bold;">Font Size <span id="font-size-display" style="font-weight: normal; font-size: 0.9em; color: #666; margin-left: 5px;">(100%)</span></span>
        <div class="font-controls">
            <button id="settings-decrease-font" aria-label="Decrease font size">-</button>
            <button id="settings-reset-font" aria-label="Reset font size" style="width: auto; padding: 0 10px;">1x</button>
            <button id="settings-increase-font" aria-label="Increase font size">+</button>
        </div>
      </div>
      <p style="color: #7f8c8d; font-size: 0.9em; margin-top: 0;">Adjust the text size for better readability.</p>
  </div>
</div>

{% if current_user.is_authenticated %}
<div class="card">
  <h2>Notification Settings</h2>
  
  <!-- Browser Permission (Client-side) -->
  <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #eee;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <strong>Browser Push Notifications</strong><br>
            <span style="font-size: 0.9em; color: #7f8c8d;">Required for Push notifications on this device.</span>
        </div>
        <label class="switch">
            <input type="checkbox" id="notifications-toggle">
            <span class="slider"></span>
        </label>
      </div>
      <p id="notif-status-text" style="font-size: 0.8em; margin-top: 5px; font-weight: bold;">Enable Notifications</p>
  </div>

  <!-- Contact Info Display -->
  <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #eee;">
      <p><strong>Mobile Phone Number:</strong></p>
      {% if current_user.phone_number %}
        <p style="margin-top: 5px;">{{ current_user.phone_number }}</p>
        <p style="font-size: 0.9em; color: #7f8c8d;">(To edit, see <a href="#profile-section">Profile Information</a> below)</p>
      {% else %}
        <p style="color: #7f8c8d; font-style: italic;">No phone number set.</p>
        <p style="font-size: 0.9em;"><a href="#profile-section">Add a phone number</a> in your profile to enable SMS options.</p>
      {% endif %}
  </div>

  <!-- Preferences -->
  <form id="notification-preferences-form">
      <h3 style="margin-top: 0;">Preferences</h3>
      <table style="width: 100%; text-align: left; border-collapse: collapse;">
          <thead>
              <tr>
                  <th style="padding-bottom: 10px;">Type</th>
                  <th style="text-align: center; padding-bottom: 10px;">Push</th>
                  <th style="text-align: center; padding-bottom: 10px;">SMS <span style="font-size: 0.8em; font-weight: normal;">(Soon)</span></th>
              </tr>
          </thead>
          <tbody>
              <tr style="border-top: 1px solid #eee;">
                  <td style="padding: 10px 0;">Prayer Reminders</td>
                  <td style="text-align: center;">
                      <input type="checkbox" name="reminders_push" {% if current_user.notification_preferences.get('prayer_reminders', {}).get('push') %}checked{% endif %}>
                  </td>
                  <td style="text-align: center;">
                      <input type="checkbox" name="reminders_sms" {% if current_user.notification_preferences.get('prayer_reminders', {}).get('sms') %}checked{% endif %} {% if not current_user.phone_number %}disabled title="Add phone number to enable"{% endif %}>
                  </td>
              </tr>
              <tr style="border-top: 1px solid #eee;">
                  <td style="padding: 10px 0;">"Someone Prayed for Me"</td>
                  <td style="text-align: center;">
                      <input type="checkbox" name="prayed_push" {% if current_user.notification_preferences.get('prayed_for_me', {}).get('push') %}checked{% endif %}>
                  </td>
                  <td style="text-align: center;">
                      <input type="checkbox" name="prayed_sms" {% if current_user.notification_preferences.get('prayed_for_me', {}).get('sms') %}checked{% endif %} {% if not current_user.phone_number %}disabled title="Add phone number to enable"{% endif %}>
                  </td>
              </tr>
          </tbody>
      </table>
      <div style="margin-top: 15px; text-align: right;">
          <button type="button" id="save-prefs-btn" class="button">Save Preferences</button>
      </div>
  </form>
</div>

<div class="card" id="profile-section">
  <h2>Profile Information</h2>
  <form action="/settings/update_profile" method="post" style="display: flex; gap: 20px; flex-wrap: wrap;">
    <div style="flex: 1 1 300px;">
        <div style="margin-bottom: 15px;">
          <label for="name">Name:</label><br>
          <input type="text" id="name" name="name" value="{{ current_user.name }}" class="form-input" required>
        </div>
        <div style="margin-bottom: 15px;">
          <label for="email">Email:</label><br>
          <input type="email" id="email" name="email" value="{{ current_user.email }}" class="form-input" required>
        </div>
        <div style="margin-bottom: 15px;">
          <label for="phone">Mobile Phone Number (Optional):</label><br>
          <input type="tel" id="phone" name="phone" value="{{ current_user.phone_number or '' }}" placeholder="+1234567890" class="form-input">
          <p style="font-size: 0.8em; color: #7f8c8d;">Format: +1234567890. Required for SMS notifications (Coming Soon).</p>
        </div>
        <button type="submit" class="button">Save Profile Changes</button>
    </div>
  </form>

  <hr>

  <h3>Profile Picture</h3>
  <div style="display: flex; align-items: flex-start; gap: 20px;">
      <div style="text-align: center;">
          <img src="{{ current_user.profile_pic }}" alt="Current Profile" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid #eee;">
      </div>
      <div style="flex-grow: 1;">
          <form action="/settings/update_picture" method="post">
            <div style="margin-bottom: 10px;">
                {% if current_user.google_profile_pic %}
                <div style="margin-bottom: 5px;">
                    <input type="radio" id="src_google" name="pic_source" value="google" {% if current_user.selected_pic_source == 'google' %}checked{% endif %}>
                    <label for="src_google">Use Google Profile Picture</label>
                </div>
                {% endif %}

                <div style="margin-bottom: 5px;">
                    <input type="radio" id="src_custom" name="pic_source" value="custom" {% if current_user.selected_pic_source == 'custom' %}checked{% endif %}>
                    <label for="src_custom">Use Custom URL</label>
                </div>
                
                <div id="custom-url-input" style="margin-top: 5px; {% if current_user.selected_pic_source != 'custom' %}display: none;{% endif %}">
                    <input type="url" name="custom_pic_url" placeholder="https://example.com/my-pic.jpg" class="form-input" value="{% if current_user.selected_pic_source == 'custom' %}{{ current_user.profile_pic }}{% endif %}">
                </div>
            </div>
            <button type="submit" class="button" style="padding: 5px 10px; font-size: 0.8em;">Update Picture</button>
          </form>
      </div>
  </div>
</div>

<div class="card">
    <h2>Prayer Reminders</h2>
    <p>Manage your prayer reminders.</p>
    <a href="/reminders" class="button">Manage Reminders</a>
</div>

<div class="card">
    <h2>Data Management</h2>
    <p>Download a copy of your personal data.</p>
    <a href="/settings/export_data" class="button" target="_blank" style="background-color: #27ae60;">Export My Prayers</a>
</div>

<div class="card">
    <h2>Account Actions</h2>
    <a href="/logout" class="button" style="background-color: #95a5a6;">Log Out</a>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging.js";

  const notifToggle = document.getElementById('notifications-toggle');
  const notifStatusText = document.getElementById('notif-status-text');
  let messaging = null;
  let cachedConfig = null;

  async function initFirebase() {
    try {
      const response = await fetch('/firebase_config');
      if (!response.ok) throw new Error("Failed to fetch config");
      cachedConfig = await response.json();
      
      const app = initializeApp(cachedConfig);
      messaging = getMessaging(app);
      
      console.log("Firebase initialized");
    } catch(e) {
      console.error("Firebase Init Error", e);
    }
  }

  async function requestPushPermission() {
    if (!('Notification' in window)) {
        alert("This browser does not support desktop notification");
        return false;
    }
    const permission = await Notification.requestPermission();
    if (permission !== 'granted') {
        alert('Permission not granted for Notification');
        return false;
    }
    
    if (!messaging) await initFirebase();
    if (!messaging) {
        alert("Failed to initialize notification service. Please refresh and try again.");
        return false;
    }

    try {
        const registration = await navigator.serviceWorker.ready;
        const options = {
            serviceWorkerRegistration: registration
        };
        if (cachedConfig && cachedConfig.vapidKey) {
            options.vapidKey = cachedConfig.vapidKey;
        }

        const currentToken = await getToken(messaging, options);
        if (currentToken) {
            await fetch('/save_fcm_token', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({token: currentToken})
            });
            console.log("FCM Token saved");
            return true; 
        } else {
            console.log('No registration token available.');
            return false;
        }
    } catch (err) {
        console.log('An error occurred while retrieving token. ', err);
        return false;
    }
  }

  async function disableNotifications() {
    try {
        if (!messaging) await initFirebase();
        if (!messaging) return;

        const registration = await navigator.serviceWorker.ready;
        const currentToken = await getToken(messaging, { serviceWorkerRegistration: registration });
        
        if (currentToken) {
            await fetch('/remove_fcm_token', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({token: currentToken})
            });
            console.log("Token removed from server.");
        }
    } catch(e) {
        console.error("Error disabling notifications:", e);
    }
  }

  function updateToggleState() {
    if (!('Notification' in window)) {
        if(notifToggle) notifToggle.disabled = true;
        if(notifStatusText) notifStatusText.textContent = "Notifications not supported";
        return;
    }

    const localEnabled = localStorage.getItem('notifications_enabled') === 'true';

    if (Notification.permission === 'granted') {
        if (localEnabled) {
            if(notifToggle) notifToggle.checked = true;
            if(notifStatusText) notifStatusText.textContent = "Notifications Enabled";
        } else {
            if(notifToggle) notifToggle.checked = false;
            if(notifStatusText) notifStatusText.textContent = "Enable Notifications";
        }
    } else if (Notification.permission === 'denied') {
        if(notifToggle) {
            notifToggle.checked = false;
            notifToggle.disabled = true;
        }
        if(notifStatusText) notifStatusText.textContent = "Notifications Denied (Check Browser Settings)";
        localStorage.setItem('notifications_enabled', 'false');
    } else {
        if(notifToggle) notifToggle.checked = false;
        if(notifStatusText) notifStatusText.textContent = "Enable Notifications";
        localStorage.setItem('notifications_enabled', 'false');
    }
  }

  if (notifToggle) {
      notifToggle.addEventListener('change', async (e) => {
        if (e.target.checked) {
            const granted = await requestPushPermission();
            if (granted) {
                notifStatusText.textContent = "Notifications Enabled";
                localStorage.setItem('notifications_enabled', 'true');
            } else {
                e.target.checked = false;
                updateToggleState();
            }
        } else {
            await disableNotifications();
            localStorage.setItem('notifications_enabled', 'false');
            notifStatusText.textContent = "Enable Notifications";
        }
      });
  }

  // Preference Saving
  const savePrefsBtn = document.getElementById('save-prefs-btn');
  if (savePrefsBtn) {
      savePrefsBtn.addEventListener('click', async () => {
          const form = document.getElementById('notification-preferences-form');
          const formData = new FormData(form);
          
          const preferences = {
              "prayer_reminders": {
                  "push": document.querySelector('input[name="reminders_push"]').checked,
                  "sms": document.querySelector('input[name="reminders_sms"]').checked
              },
              "prayed_for_me": {
                  "push": document.querySelector('input[name="prayed_push"]').checked,
                  "sms": document.querySelector('input[name="prayed_sms"]').checked
              }
          };

          try {
              const response = await fetch('/settings/save_notification_preferences', {
                  method: 'POST',
                  headers: {'Content-Type': 'application/json'},
                  body: JSON.stringify({preferences: preferences})
              });
              const result = await response.json();
              if (result.success) {
                  alert("Preferences saved successfully.");
              } else {
                  alert("Error saving preferences: " + result.error);
              }
          } catch(e) {
              console.error(e);
              alert("An error occurred.");
          }
      });
  }

  document.addEventListener('DOMContentLoaded', () => {
      initFirebase();
      updateToggleState();
  });
</script>

<script>
    const radios = document.querySelectorAll('input[name="pic_source"]');
    const customInputDiv = document.getElementById('custom-url-input');

    radios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'custom') {
                customInputDiv.style.display = 'block';
            } else {
                customInputDiv.style.display = 'none';
            }
        });
    });
</script>
{% else %}
<div class="card">
    <h2>Account</h2>
    <p>Log in to sync your settings, data, and receive reminders across devices.</p>
    <a href="/login" class="button" style="background-color: #2980b9;">Log In / Sign Up</a>
</div>
{% endif %}
{% endblock %}
