{% extends parent_template|default("base.html") %}
{% import "_macros.html" as macros with context %}
{% block title %}Evening Devotion{% endblock %}
{% block head %}
<link rel="preload" as="image" href="{{ url_for('static', filename='banner_evening.jpg') }}">
{% endblock %}
{% block content %}
    <div class="page-header" style="--bg-image: url('{{ url_for('static', filename='banner_evening.jpg', _external=True) }}');">
      <h1>Evening Devotion</h1>
      <p>
        {{ date_str }}<br />
        <span style="color: #7f8c8d">Lectionary Day: {{ key }}</span>
      </p>
      <p style="font-style: italic; margin-top: 10px;">"If such an abundance of good thoughts comes to us we ought to disregard the other petitions, make room for such thoughts, listen in silence, and under no circumstances obstruct them. The Holy Spirit himself preaches here, and one word of his sermon is far better than a thousand of our prayers. Many times I have learned more from one prayer than I might have learned from much reading and speculation." — Martin Luther</p>
    </div>

    {% call macros.card('Opening') %}
        <p>
          <span class="rubric"
            >The sign of the cross may be made by all in remembrance of their Baptism.</span
          >
        </p>
        <p>
          In the name of the Father and of the † Son and of the Holy Spirit.<br />
          <strong> Amen.</strong>
        </p>
        <p>
          Let my prayer rise before You as incense,<br />
          <strong>the lifting up of my hands as the evening sacrifice.</strong>
          <span class="versicle-ref">Psalm 141:2</span>
        </p>
        <p>
          <strong
            >Joyous light of glory:<br />
            of the immortal Father;<br />
            heavenly, holy, blessed Jesus Christ.<br />
            We have come to the setting of the sun,<br />
            and we look to the evening light.<br />
            We sing to God, the Father, Son, and Holy Spirit:<br />
            You are worthy of being praised with pure voices forever.<br />
            O Son of God, O Giver of life: the universe proclaims Your glory.</strong
          >
        </p>
    {% endcall %}

    {% call macros.card('Psalmody') %}
        <span class="ref" id="ref-psalm">{{ psalm_ref }}</span>
        <p id="text-psalm">{{ psalm_text|safe }}</p>
        {% if psalm_options %}
        <button class="button picker-toggle-button" onclick="togglePicker(this, 'psalm')">Select Psalm</button>
        <div id="picker-psalm" class="item-picker">
            {% for p in psalm_options %}
            <button class="button picker-select-button" onclick="selectRef('{{ p }}', 'psalm')">{{ p }}</button>
            {% endfor %}
        </div>
        {% endif %}
        {{ macros.format_prayer(config['OTHER_PRAYERS']['gloria_patri']) }}
    {% endcall %}

    {% call macros.card('Reading') %}
        <div id="office-reading-container">
            <span class="ref" id="ref-reading">{{ reading_ref }}</span>
            <p id="text-reading">{{ reading_text|safe }}</p>
            <button class="button picker-toggle-button" id="office-picker-btn" onclick="togglePicker(this, 'reading')">Select Reading</button>
            <div id="picker-reading" class="item-picker">
                {% for r in reading_options %}
                <button class="button picker-select-button" onclick="selectRef('{{ r }}', 'reading')">{{ r }}</button>
                {% endfor %}
            </div>
        </div>

        <div id="lectionary-reading-container" style="display: none;">
            {% if daily_lectionary_readings %}
                <p class="subheader"><strong>Old Testament Reading</strong></p>
                <span class="ref">{{ daily_lectionary_readings[0] }}</span>
                <p>{{ lectionary_texts[0]|safe }}</p>
                {% if daily_lectionary_readings|length > 1 %}
                    <hr>
                    <p class="subheader"><strong>New Testament Reading</strong></p>
                    <span class="ref">{{ daily_lectionary_readings[1] }}</span>
                    <p>{{ lectionary_texts[1]|safe }}</p>
                {% endif %}
            {% else %}
                <p><em>No Daily Lectionary readings available for today.</em></p>
            {% endif %}
        </div>

        <div style="margin-top: 10px;">
            <button id="btn-toggle-lectionary" class="button" onclick="toggleLectionaryReadings()" style="background-color: #2980b9;">Switch to Daily Lectionary</button>
        </div>
    {% endcall %}

    {% if catechism_enabled %}
    {% call macros.card('Catechism: ' ~ catechism_title) %}
        {% if catechism_text %}
          <p>{{ catechism_text|safe }}</p>
        {% endif %}
        {% for qa in questions_and_answers %}
          <div class="catechism-qa">
            <p><strong>{{ qa.question }}</strong></p>
            <p>{{ qa.answer|safe }}</p>
          </div>
        {% endfor %}
        {% if catechism_prayer %}
        <p><strong>Prayer:</strong> {{ catechism_prayer|safe }}</p>
        {% endif %}
        <span class="versicle-ref">Catechism source: <a href="https://bookofconcord.org/small-catechism/" target="_blank">bookofconcord.org</a></span>
    {% endcall %}
    {% endif %}

    {% call macros.card('Prayers') %}
        {{ macros.format_prayer(config['OTHER_PRAYERS']['lords_prayer']) }}
        <hr />
        <p><em>(You may offer your own prayers at this time)</em></p>
        {{ macros.personal_prayers_toggle(all_personal_prayers) }}
        <hr />
        <p class="subheader"><strong>Concluding Prayer</strong></p>
        {{ macros.format_prayer(concluding_prayer) }}
    {% endcall %}

    {{ macros.prayer_complete_button('evening') }}

    {% call macros.card('Conclusion') %}
        <p>
          Let us bless the Lord.<br />
          <strong>Thanks be to God.</strong>
        </p>
    {% endcall %}
{% endblock %}

{% block extra_js %}
    window.suppressDefaultArt = true;
    let isLectionaryMode = false;

    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('reading_type') === 'lectionary') {
            toggleLectionaryReadings();
        }
    });

    function toggleLectionaryReadings() {
       const btn = document.getElementById('btn-toggle-lectionary');
       const officeContainer = document.getElementById('office-reading-container');
       const lectionaryContainer = document.getElementById('lectionary-reading-container');
       const picker = document.getElementById('picker-reading');
       const pickerBtn = document.getElementById('office-picker-btn');

       if (isLectionaryMode) {
           // Swap back to Office
           officeContainer.style.display = 'block';
           lectionaryContainer.style.display = 'none';
           btn.innerText = "Switch to Daily Lectionary";
           isLectionaryMode = false;
       } else {
           // Swap to Lectionary
           // Close picker if open to reset state
           if (picker.classList.contains('visible')) {
               togglePicker(pickerBtn, 'reading');
           }
           
           officeContainer.style.display = 'none';
           lectionaryContainer.style.display = 'block';
           btn.innerText = "Back to Office Reading";
           isLectionaryMode = true;
       }
    }

    document.addEventListener('DOMContentLoaded', async () => {
        const readingRef = "{{ reading_ref }}";
        const theme = "Light"; // Evening theme
        try {
            const response = await fetch(`/api/lectionary/art?ref=${encodeURIComponent(readingRef)}&theme=${encodeURIComponent(theme)}`);
            const data = await response.json();
            if (data && data.image_url) {
                displayBackgroundArt(data);
            }
        } catch (e) {
            console.error("Failed to fetch background art", e);
        }
    });
{% endblock %}
