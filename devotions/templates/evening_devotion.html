{% extends parent_template|default("base.html") %}
{% import "_macros.html" as macros with context %}
{% block title %}Evening Devotion{% endblock %}
{% block head %}
<link rel="preload" as="image" href="{{ url_for('static', filename='banner_evening.jpg') }}">
{% endblock %}
{% block content %}
    <div class="page-header" style="--bg-image: url('{{ url_for('static', filename='banner_evening.jpg', _external=True) }}');">
      <h1>Evening Devotion</h1>
      <p>
        {{ date_str }}<br />
        <span style="color: #7f8c8d">Lectionary Day: {{ key }}</span>
      </p>
      <p style="font-style: italic; margin-top: 10px;">"If such an abundance of good thoughts comes to us we ought to disregard the other petitions, make room for such thoughts, listen in silence, and under no circumstances obstruct them. The Holy Spirit himself preaches here, and one word of his sermon is far better than a thousand of our prayers. Many times I have learned more from one prayer than I might have learned from much reading and speculation." — Martin Luther</p>
    </div>

    {% call macros.card('Opening') %}
        <p>
          <span class="rubric"
            >The sign of the cross may be made by all in remembrance of their Baptism.</span
          >
        </p>
        <p>
          In the name of the Father and of the † Son and of the Holy Spirit.<br />
          <strong> Amen.</strong>
        </p>
        <p>
          Let my prayer rise before You as incense,<br />
          <strong>the lifting up of my hands as the evening sacrifice.</strong>
          <span class="versicle-ref">Psalm 141:2</span>
        </p>
        <p>
          <strong
            >Joyous light of glory:<br />
            of the immortal Father;<br />
            heavenly, holy, blessed Jesus Christ.<br />
            We have come to the setting of the sun,<br />
            and we look to the evening light.<br />
            We sing to God, the Father, Son, and Holy Spirit:<br />
            You are worthy of being praised with pure voices forever.<br />
            O Son of God, O Giver of life: the universe proclaims Your glory.</strong
          >
        </p>
    {% endcall %}

    {% call macros.card('Psalmody') %}
        <span class="ref" id="ref-psalm">{{ psalm_ref }}</span>
        <p id="text-psalm">{{ psalm_text|safe }}</p>
        {% if psalm_options %}
        <button class="button picker-toggle-button" onclick="togglePicker(this, 'psalm')">Select Psalm</button>
        <div id="picker-psalm" class="item-picker">
            {% for p in psalm_options %}
            <button class="button picker-select-button" onclick="selectRef('{{ p }}', 'psalm')">{{ p }}</button>
            {% endfor %}
        </div>
        {% endif %}
        {{ macros.format_prayer(config['OTHER_PRAYERS']['gloria_patri']) }}
    {% endcall %}

    {% call macros.card('Reading') %}
        <div id="office-reading-container">
            <span class="ref" id="ref-reading">{{ reading_ref }}</span>
            <p id="text-reading">{{ reading_text|safe }}</p>
            <button class="button picker-toggle-button" id="office-picker-btn" onclick="togglePicker(this, 'reading')">Select Reading</button>
            <div id="picker-reading" class="item-picker">
                {% for r in reading_options %}
                <button class="button picker-select-button" onclick="selectRef('{{ r }}', 'reading')">{{ r }}</button>
                {% endfor %}
            </div>
        </div>

        <div id="lectionary-reading-container" style="display: none;">
            {% if daily_lectionary_readings %}
                <p class="subheader"><strong>Old Testament Reading</strong></p>
                <span class="ref">{{ daily_lectionary_readings[0] }}</span>
                <p>{{ lectionary_texts[0]|safe }}</p>
                {% if daily_lectionary_readings|length > 1 %}
                    <hr>
                    <p class="subheader"><strong>New Testament Reading</strong></p>
                    <span class="ref">{{ daily_lectionary_readings[1] }}</span>
                    <p>{{ lectionary_texts[1]|safe }}</p>
                {% endif %}
            {% else %}
                <p><em>No Daily Lectionary readings available for today.</em></p>
            {% endif %}
        </div>

        <div id="bible-year-reading-container" style="display: none;">
            {% if bible_in_a_year_reading %}
                <p class="subheader"><strong>Old Testament</strong></p>
                <span class="ref">{{ bible_in_a_year_reading.ot_ref }}</span>
                <p>{{ bible_in_a_year_reading.ot_text|safe }}</p>
                <hr>
                <p class="subheader"><strong>New Testament</strong></p>
                <span class="ref">{{ bible_in_a_year_reading.nt_ref }}</span>
                <p>{{ bible_in_a_year_reading.nt_text|safe }}</p>
                <hr>
                <p class="subheader"><strong>Psalms & Proverbs</strong></p>
                <span class="ref">{{ bible_in_a_year_reading.psp_ref }}</span>
                <p>{{ bible_in_a_year_reading.psp_text|safe }}</p>
            {% else %}
                 <p><em>Bible in a Year reading not available.</em></p>
            {% endif %}
        </div>

        <div style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 10px;">
            <label for="reading-mode-select" style="font-weight: bold; align-self: center;">Reading Plan:</label>
            <select id="reading-mode-select" onchange="setReadingMode(this.value)" class="form-input" style="width: auto; padding: 5px;">
                <option value="office">Office Reading (Rotating)</option>
                <option value="lectionary">Daily Lectionary (Church Year)</option>
                <option value="bible_year">Bible in a Year (Day {{ bible_in_a_year_reading.day_number }})</option>
            </select>
        </div>
    {% endcall %}

    {% if catechism_enabled %}
    {% call macros.card('Catechism: ' ~ catechism_title) %}
        {% if catechism_text %}
          <p>{{ catechism_text|safe }}</p>
        {% endif %}
        {% for qa in questions_and_answers %}
          <div class="catechism-qa">
            <p><strong>{{ qa.question }}</strong></p>
            <p>{{ qa.answer|safe }}</p>
          </div>
        {% endfor %}
        {% if catechism_prayer %}
        <p><strong>Prayer:</strong> {{ catechism_prayer|safe }}</p>
        {% endif %}
        <span class="versicle-ref">Catechism source: <a href="https://bookofconcord.org/small-catechism/" target="_blank">bookofconcord.org</a></span>
    {% endcall %}
    {% endif %}

    {% call macros.card('Prayers') %}
        {{ macros.format_prayer(config['OTHER_PRAYERS']['lords_prayer']) }}
        <hr />
        <p><em>(You may offer your own prayers at this time)</em></p>
        {{ macros.personal_prayers_toggle(all_personal_prayers) }}
        <hr />
        <p class="subheader"><strong>Concluding Prayer</strong></p>
        {{ macros.format_prayer(concluding_prayer) }}
    {% endcall %}

    {{ macros.prayer_complete_button('evening') }}

    {% call macros.card('Conclusion') %}
        <p>
          Let us bless the Lord.<br />
          <strong>Thanks be to God.</strong>
        </p>
    {% endcall %}
{% endblock %}

{% block extra_js %}
    window.suppressDefaultArt = true;
    
    // Store current reading mode
    let currentReadingMode = 'office';
    const bibleYearDay = {{ bible_in_a_year_reading.day_number|tojson }};

    function setReadingMode(mode) {
       const officeContainer = document.getElementById('office-reading-container');
       const lectionaryContainer = document.getElementById('lectionary-reading-container');
       const bibleYearContainer = document.getElementById('bible-year-reading-container');
       const select = document.getElementById('reading-mode-select');
       
       // Close picker if open
       const picker = document.getElementById('picker-reading');
       const pickerBtn = document.getElementById('office-picker-btn');
       if (picker && picker.classList.contains('visible')) {
           togglePicker(pickerBtn, 'reading');
       }

       // Hide all first
       if(officeContainer) officeContainer.style.display = 'none';
       if(lectionaryContainer) lectionaryContainer.style.display = 'none';
       if(bibleYearContainer) bibleYearContainer.style.display = 'none';

       if (mode === 'office') {
           if(officeContainer) officeContainer.style.display = 'block';
           currentReadingMode = 'office';
       } else if (mode === 'lectionary') {
           if(lectionaryContainer) lectionaryContainer.style.display = 'block';
           currentReadingMode = 'lectionary';
       } else if (mode === 'bible_year') {
           if(bibleYearContainer) bibleYearContainer.style.display = 'block';
           currentReadingMode = 'bible_year';
       }
       
       if (select) select.value = mode;
    }
    
    const originalMarkPrayerComplete = window.markPrayerComplete;
    
    window.markPrayerComplete = async function(devotionType) {
        const btn = document.getElementById('btn-complete-prayer');
        const msg = document.getElementById('prayer-complete-msg');
        
        if (btn) btn.disabled = true;
        
        const payload = { devotion_type: devotionType };
        
        // If current mode is Bible Year, add the day number
        if (currentReadingMode === 'bible_year') {
            payload.bible_year_day = bibleYearDay;
        }
        
        try {
            const response = await fetch('/api/complete_prayer', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await response.json();
            
            if (data.streak !== undefined) {
                // Update UI
                if (msg) {
                    msg.style.display = 'block';
                    if (data.message) {
                        msg.textContent = data.message;
                    } else if (data.already_prayed) {
                        msg.textContent = "You've already prayed today! Streak: " + data.streak;
                    } else {
                        msg.textContent = "Prayer recorded! Current Streak: " + data.streak + " days";
                    }
                    
                    if (data.bible_milestone_reached) {
                        // Append bible milestone info
                         msg.textContent += " (Bible Reading Recorded!)";
                    }
                }
                if (btn) {
                    btn.style.backgroundColor = "#95a5a6";
                    btn.style.cursor = "not-allowed";
                    btn.innerHTML = '<span style="margin-right: 8px;">✓</span> Completed';
                }
                
                const navStreak = document.getElementById('nav-streak-count');
                if (navStreak) navStreak.textContent = data.streak;
                
                if (data.milestone_reached) {
                    showMilestonePopup(data.milestone_msg, data.streak);
                }
            }
        } catch (e) {
            console.error("Error marking prayer complete:", e);
            if (btn) btn.disabled = false;
            alert("Failed to record prayer. Please check your connection.");
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('reading_type') === 'lectionary') {
            setReadingMode('lectionary');
        } else if (urlParams.get('reading_type') === 'bible_in_a_year') {
            setReadingMode('bible_year');
        }
    });

    document.addEventListener('DOMContentLoaded', async () => {
        const readingRef = "{{ reading_ref }}";
        const theme = "Light"; // Evening theme
        try {
            const response = await fetch(`/api/lectionary/art?ref=${encodeURIComponent(readingRef)}&theme=${encodeURIComponent(theme)}`);
            const data = await response.json();
            if (data && data.image_url) {
                displayBackgroundArt(data);
            }
        } catch (e) {
            console.error("Failed to fetch background art", e);
        }
    });
{% endblock %}
