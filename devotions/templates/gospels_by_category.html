{% extends "base.html" %}
{% import "_macros.html" as macros %}

{% block title %}Gospels by Category{% endblock %}

{% block content %}
    <div style="text-align: center; margin-bottom: 40px">
      <h1>Gospels by Category</h1>
      <p>Select a category to view a Gospel reading and prayer for reflection.</p>
    </div>

    {% for cat in category_data %}
      {% set i = loop.index0 %}
      {% call macros.card(cat.title, collapsed=True) %}
        <p><em>{{ cat.description }}</em></p>
        <hr>
        <span class="ref" id="verse-ref-{{ i }}">{{ cat.initial_verse_ref }}</span>
        <p id="verse-text-{{ i }}">{{ cat.initial_verse_text|safe }}</p>
        <button class="button verse-button" onclick="toggleVersePicker(this, {{ i }})">Select Reading</button>
        <div id="picker-{{ i }}" class="verse-picker">
            {% for v in cat.verses %}
            <button class="button verse-picker-button" onclick="selectVerse('{{ v }}', {{ i }})">{{ v }}</button>
            {% endfor %}
        </div>
        <hr>
        <p class="subheader"><strong>Prayer</strong></p>
        <p>{{ cat.prayer }}</p>
      {% endcall %}
    {% endfor %}
{% endblock %}

{% block extra_js %}
      function toggleVersePicker(button, cardIndex) {
        const picker = document.getElementById("picker-" + cardIndex);
        picker.classList.toggle("visible");
        if (picker.classList.contains("visible")) {
          button.innerText = "Hide Reading List";
        } else {
          button.innerText = "Select Reading";
        }
      }

      async function selectVerse(newRef, cardIndex) {
        const picker = document.getElementById("picker-" + cardIndex);
        picker.classList.remove("visible"); // Hide picker
        const mainButton = picker.previousElementSibling;
        mainButton.innerText = "Select Reading"; // Reset button text

        const currentRefEl = document.getElementById("verse-ref-" + cardIndex);
        const textEl = document.getElementById("verse-text-" + cardIndex);

        if (currentRefEl.innerText === newRef) {
          return; // Already showing this verse
        }

        currentRefEl.innerText = newRef;
        textEl.innerHTML = "<em>Loading...</em>";
        mainButton.disabled = true; // Disable main button during fetch

        try {
          const response = await fetch("/get_passage_text?ref=" + encodeURIComponent(newRef));
          if (!response.ok) throw new Error("Network response was not ok");
          const data = await response.json();
          textEl.innerHTML = data.text;
        } catch (error) {
          console.error("Error fetching new verse:", error);
          textEl.innerHTML = "<em>Error loading " + newRef + ". Please try again.</em>";
        } finally {
          mainButton.disabled = false;
        }
      }
{% endblock %}
