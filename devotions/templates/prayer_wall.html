{% extends "base.html" %} {% block title %}Prayer Wall{% endblock %} {% block content %}
    <div class="page-header">
      <h1>Prayer Wall</h1>
      <p style="font-style: italic; margin-top: 10px;">"You should also know that I do not want you to recite all these words in your prayer. That would make it nothing but idle chatter and prattle. Rather do I want your heart to be stirred and guided concerning the thoughts . . . expressed, if your heart is rightly warmed and inclined toward prayer, in many different ways and with more words or fewer." ‚Äî Martin Luther</p>
    </div>

    <div class="card">
      <h2>Prayer Wall</h2>
      <p>Below are a list of prayer requests, you can choose to pray for any or all of them.</p>
    </div>

    {% if not prayer_requests %}
      <div class="card">
        <p><em>No active prayer requests at this time.</em></p>
      </div>
    {% else %}
      <ul class="prayer-wall-container">
      {% for req in prayer_requests %}
        <li class="post-it" data-id="{{ req.id }}">
          {% if current_user.is_authenticated and req.user_id == current_user.id %}
            <div class="owner-controls" style="float: right; margin-left: 10px;">
                <button class="button" style="padding: 5px 10px; font-size: 0.8em;" onclick="editPrayerRequest('{{ req.id }}')">Edit</button>
                <button class="button" style="background-color: #e74c3c; padding: 5px 10px; font-size: 0.8em;" onclick="deletePrayerRequest('{{ req.id }}')">Delete</button>
            </div>
          {% endif %}
          <p class="post-it-text">{{ req.request }}</p>
          <div class="post-it-footer">
              <div class="pray-container">
                  <button class="pray-button {% if req.id in prayed_request_ids %}prayed{% endif %}">üôè</button>
                  <span class="pray-count">{{ req.pray_count }}</span>
              </div>
              <p class="post-it-name">~ {{ req.name }}</p>
          </div>
        </li>
      {% endfor %}
      </ul>
    {% endif %}

    <div style="text-align: center">
      <a href="/prayer_requests" class="button">Submit a Prayer Request</a>
    </div>
{% endblock %}

{% block extra_js %}
async function deletePrayerRequest(requestId) {
    if (!confirm('Are you sure you want to delete this prayer request?')) {
        return;
    }
    try {
        const response = await fetch(`/delete_prayer_request/${requestId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
        });
        if (response.ok) {
            const postIt = document.querySelector(`.post-it[data-id="${requestId}"]`);
            if (postIt) {
                postIt.remove();
            }
        } else {
            const error = await response.json();
            alert(`Failed to delete prayer request: ${error.error || 'Unknown error'}`);
        }
    } catch (error) {
        console.error('Error deleting prayer request:', error);
        alert('An error occurred while deleting the prayer request.');
    }
}

function editPrayerRequest(requestId) {
    const postIt = document.querySelector(`.post-it[data-id="${requestId}"]`);
    if (!postIt) return;

    const textP = postIt.querySelector('.post-it-text');
    const currentText = textP.textContent;
    const currentTextB64 = btoa(encodeURIComponent(currentText));

    const textArea = document.createElement('textarea');
    textArea.value = currentText;
    textArea.className = 'post-it-text-edit form-input';
    textArea.style.width = '100%';
    textArea.style.height = '100px';
    textArea.style.marginBottom = '10px';
    textP.replaceWith(textArea);

    const controlsDiv = postIt.querySelector('.owner-controls');
    controlsDiv.innerHTML = `
        <button class="button" style="padding: 5px 10px; font-size: 0.8em;" onclick="savePrayerRequest('${requestId}')">Save</button>
        <button class="button" style="background-color: #95a5a6; padding: 5px 10px; font-size: 0.8em;" onclick="cancelEdit('${requestId}', '${currentTextB64}')">Cancel</button>
    `;
}

function cancelEdit(requestId, originalTextB64) {
    const postIt = document.querySelector(`.post-it[data-id="${requestId}"]`);
    if (!postIt) return;
    const originalText = decodeURIComponent(atob(originalTextB64));

    const textArea = postIt.querySelector('.post-it-text-edit');
    const textP = document.createElement('p');
    textP.className = 'post-it-text';
    textP.textContent = originalText;
    textArea.replaceWith(textP);

    const controlsDiv = postIt.querySelector('.owner-controls');
    controlsDiv.innerHTML = `
        <button class="button" style="padding: 5px 10px; font-size: 0.8em;" onclick="editPrayerRequest('${requestId}')">Edit</button>
        <button class="button" style="background-color: #e74c3c; padding: 5px 10px; font-size: 0.8em;" onclick="deletePrayerRequest('${requestId}')">Delete</button>
    `;
}

async function savePrayerRequest(requestId) {
    const postIt = document.querySelector(`.post-it[data-id="${requestId}"]`);
    if (!postIt) return;
    const textArea = postIt.querySelector('.post-it-text-edit');
    const newText = textArea.value;

    try {
        const response = await fetch(`/edit_prayer_request/${requestId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ request: newText }),
        });
        if (response.ok) {
            const textP = document.createElement('p');
            textP.className = 'post-it-text';
            textP.textContent = newText;
            textArea.replaceWith(textP);

            const controlsDiv = postIt.querySelector('.owner-controls');
            controlsDiv.innerHTML = `
                <button class="button" style="padding: 5px 10px; font-size: 0.8em;" onclick="editPrayerRequest('${requestId}')">Edit</button>
                <button class="button" style="background-color: #e74c3c; padding: 5px 10px; font-size: 0.8em;" onclick="deletePrayerRequest('${requestId}')">Delete</button>
            `;
        } else {
            const error = await response.json();
            alert(`Failed to save prayer request: ${error.error || 'Unknown error'}`);
        }
    } catch (error) {
        console.error('Error saving prayer request:', error);
        alert('An error occurred while saving the prayer request.');
    }
}

document.addEventListener('DOMContentLoaded', () => {
    const prayerButtons = document.querySelectorAll('.pray-button');
    const storagePrefix = 'prayed_';

    prayerButtons.forEach(button => {
        const postIt = button.closest('.post-it');
        const requestId = postIt.dataset.id;
        const countSpan = postIt.querySelector('.pray-count');
        let prayCount = parseInt(countSpan.textContent);

        // Check local storage on load
        if (localStorage.getItem(storagePrefix + requestId)) {
            button.classList.add('prayed');
        }

        button.addEventListener('click', async () => {
            const isPrayed = button.classList.toggle('prayed');
            let operation = '';

            if (isPrayed) {
                prayCount++;
                localStorage.setItem(storagePrefix + requestId, 'true');
                operation = 'increment';
            } else {
                prayCount--;
                localStorage.removeItem(storagePrefix + requestId);
                operation = 'decrement';
            }
            
            countSpan.textContent = prayCount;

            // Send update to server
            try {
                const response = await fetch('/update_pray_count', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ id: requestId, operation: operation }),
                });
                if (!response.ok) {
                    console.error('Failed to update pray count on server');
                }
            } catch (error) {
                console.error('Error sending pray count update:', error);
            }
        });
    });
});
{% endblock %}
