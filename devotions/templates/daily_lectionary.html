{% extends "base.html" %}
{% import "_macros.html" as macros %}

{% block title %}Daily Lectionary{% endblock %}

{% block content %}
    <div id="art-background" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background-size: cover; background-position: center; opacity: 0; transition: opacity 2s ease; filter: sepia(0.4) blur(2px);"></div>

    <div class="page-header">
      <h1>Daily Lectionary</h1>
      <p>
        {{ date_str }}<br />
        <span style="color: #7f8c8d">Lectionary Day: {{ key }}</span>
      </p>
    </div>

    {% call macros.card('Old Testament Reading') %}
        <span class="ref">{{ ot_ref }}</span>
        <p>{{ ot_text|safe }}</p>
    {% endcall %}

    {% call macros.card('New Testament Reading') %}
        <span class="ref">{{ nt_ref }}</span>
        <p>{{ nt_text|safe }}</p>
    {% endcall %}

    <div id="art-credit" style="text-align: center; font-size: 0.8em; margin-top: 20px; display: none; color: #7f8c8d;">
        Background Art: <a id="art-link" href="#" target="_blank" style="color: inherit; text-decoration: underline;"><span id="art-title"></span></a> (Full of Eyes)
    </div>

{% endblock %}

{% block extra_js %}
    document.addEventListener('DOMContentLoaded', () => {
        const ntRef = "{{ nt_ref }}";
        const bg = document.getElementById('art-background');
        const credit = document.getElementById('art-credit');
        const title = document.getElementById('art-title');
        const link = document.getElementById('art-link');

        function displayArt(data) {
            const img = new Image();
            img.onload = () => {
                bg.style.backgroundImage = `url('${data.image_url}')`;
                bg.style.opacity = 0.25;
            };
            img.src = data.image_url;

            title.textContent = data.title;
            link.href = data.link;
            credit.style.display = 'block';
        }

        async function tryFetchArt() {
            if (ntRef && ntRef !== "Reading not found") {
                try {
                    console.log(`Fetching art for NT ref: ${ntRef}`);
                    const response = await fetch(`/api/lectionary/art?ref=${encodeURIComponent(ntRef)}`);
                    const data = await response.json();
                    if (data.image_url) {
                        displayArt(data);
                        return;
                    }
                } catch (e) {
                    console.error("Error fetching NT art", e);
                }
            }
        }

        tryFetchArt();
    });
{% endblock %}
