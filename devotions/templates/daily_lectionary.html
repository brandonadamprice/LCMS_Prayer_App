{% extends "base.html" %}
{% import "_macros.html" as macros %}

{% block title %}Daily Lectionary{% endblock %}

{% block content %}
    <div class="page-header">
      <h1>Daily Lectionary</h1>
      <p>
        {{ date_str }}<br />
        <span style="color: #7f8c8d">Lectionary Day: {{ key }}</span>
      </p>
    </div>

    {% call macros.card('Old Testament Reading') %}
        <span class="ref">{{ ot_ref }}</span>
        <p>{{ ot_text|safe }}</p>
    {% endcall %}

    {% call macros.card('New Testament Reading') %}
        <span class="ref">{{ nt_ref }}</span>
        <p>{{ nt_text|safe }}</p>
    {% endcall %}

    {% call macros.card('Art') %}
        <div id="art-container" style="text-align: center; display: none;">
             <img id="art-image" style="max-width: 100%; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" alt="Relevant Art">
             <p id="art-title" style="font-style: italic; color: #666; margin-top: 5px;"></p>
             <p style="font-size: 0.8em;"><a id="art-link" href="#" target="_blank">View on Full of Eyes</a></p>
        </div>
        <p id="art-loading"><em>Searching for relevant art...</em></p>
    {% endcall %}

{% endblock %}

{% block extra_js %}
    document.addEventListener('DOMContentLoaded', () => {
        const ntRef = "{{ nt_ref }}";
        const otRef = "{{ ot_ref }}";
        const container = document.getElementById('art-container');
        const loading = document.getElementById('art-loading');

        function displayArt(data) {
            document.getElementById('art-image').src = data.image_url;
            document.getElementById('art-title').textContent = data.title;
            document.getElementById('art-link').href = data.link;
            container.style.display = 'block';
            loading.style.display = 'none';
        }

        async function tryFetchArt() {
            // Try NT first
            if (ntRef && ntRef !== "Reading not found") {
                try {
                    console.log(`Fetching art for NT ref: ${ntRef}`);
                    const response = await fetch(`/api/lectionary/art?ref=${encodeURIComponent(ntRef)}`);
                    const data = await response.json();
                    if (data.image_url) {
                        displayArt(data);
                        return;
                    }
                } catch (e) {
                    console.error("Error fetching NT art", e);
                }
            }

            // Fallback to OT
            if (otRef && otRef !== "Reading not found") {
                try {
                    console.log(`Fetching art for OT ref: ${otRef}`);
                    const response = await fetch(`/api/lectionary/art?ref=${encodeURIComponent(otRef)}`);
                    const data = await response.json();
                    if (data.image_url) {
                        displayArt(data);
                        return;
                    }
                } catch (e) {
                    console.error("Error fetching OT art", e);
                }
            }

            // Nothing found
            loading.innerHTML = "<em>No art found.</em>";
        }

        tryFetchArt();
    });
{% endblock %}
