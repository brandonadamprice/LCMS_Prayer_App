{% extends "base.html" %}
{% import "_macros.html" as macros %}

{% block title %}Psalms by Category{% endblock %}

{% block content %}
    <div style="text-align: center; margin-bottom: 40px">
      <h1>Psalms by Category</h1>
      <p>Select a category to view a Psalm and prayer for reflection.</p>
    </div>

    {% for cat in category_data %}
      {% set i = loop.index0 %}
      {% call macros.card(cat.title, collapsed=True) %}
        <p><em>{{ cat.description }}</em></p>
        <hr>
        <span class="ref" id="psalm-ref-{{ i }}">{{ cat.initial_psalm_ref }}</span>
        <p id="psalm-text-{{ i }}">{{ cat.initial_psalm_text|safe }}</p>
        <button class="button psalm-button" onclick="togglePsalmPicker(this, {{ i }})">Select Psalm</button>
        <div id="picker-{{ i }}" class="psalm-picker">
            {% for p in cat.psalms %}
            <button class="button psalm-picker-button" onclick="selectPsalm('{{ p }}', {{ i }})">{{ p }}</button>
            {% endfor %}
        </div>
        <hr>
        <p class="subheader"><strong>Prayer</strong></p>
        <p>{{ cat.prayer }}</p>
      {% endcall %}
    {% endfor %}
{% endblock %}

{% block extra_js %}
      function togglePsalmPicker(button, cardIndex) {
        const picker = document.getElementById("picker-" + cardIndex);
        picker.classList.toggle("visible");
        if (picker.classList.contains("visible")) {
          button.innerText = "Hide Psalm List";
        } else {
          button.innerText = "Select Psalm";
        }
      }

      async function selectPsalm(psalmNum, cardIndex) {
        const picker = document.getElementById("picker-" + cardIndex);
        picker.classList.remove("visible"); // Hide picker
        const mainButton = picker.previousElementSibling;
        mainButton.innerText = "Select Psalm"; // Reset button text

        const newRef = "Psalm " + psalmNum;
        const currentRefEl = document.getElementById("psalm-ref-" + cardIndex);
        const textEl = document.getElementById("psalm-text-" + cardIndex);

        if (currentRefEl.innerText === newRef) {
          return; // Already showing this psalm
        }

        currentRefEl.innerText = newRef;
        textEl.innerHTML = "<em>Loading...</em>";
        mainButton.disabled = true; // Disable main button during fetch

        try {
          const response = await fetch("/get_passage_text?ref=" + encodeURIComponent(newRef));
          if (!response.ok) throw new Error("Network response was not ok");
          const data = await response.json();
          textEl.innerHTML = data.text;
        } catch (error) {
          console.error("Error fetching new psalm:", error);
          textEl.innerHTML = "<em>Error loading Psalm " + psalmNum + ". Please try again.</em>";
        } finally {
          mainButton.disabled = false;
        }
      }
{% endblock %}
